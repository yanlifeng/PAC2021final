# PAC2021 final -- ChiFanBuZhangRou

TODOs

- [x] Add rabbitio
- [x] Use other map
- [ ] Parallel in load map----8*hashmapï¼Œomp merge
- [ ] Use secondary index
- [x] Use list-hash
- [ ] Use aili-code ï¼Ÿï¼Ÿï¼Ÿ
- [ ] Optimize match algorithm
- [x] Use gcc7 / gcc11
- [x] Use icc
- [x] Add pugz
- [ ] Read se not pe
- [x] Use parallel zip when write
- [ ] Check todos ğŸ‘‡ï¼ˆ//TODOï¼‰
- [x] Why write .fq.gz size diff ?
- [ ] Write fq in order?
- [x] queue1 more bigger (128x128 -> 128x1024)
- [ ] change block size in pugz(32kb -> 4mb)
- [x] change block size in pigz
- [ ] change queue1 to dataPool to decrease new and delete operations
- [x] fix pigzWrite bugï¼Ÿï¼Ÿ
- [ ] mod all barcode to 1e9, use it dirctely, cal time
- [x] test Gâ€˜s map
- [ ] test 0 3 6 9
- [x] merge mip write part
- [x] checkğŸ‘†
- [x] add bloom filter
- [ ] make bf bitset smaller or more small bitset to replace the big one
- [ ] make bf bitset bigger
- [ ] try bf with 3 bitset
- [x] calculate bf size
- [x] add mpi pugz
- [x] add mpi pigz
- [ ] merge hashHead hashMap
- [ ] check asm to find why gcc11 has a good perfermance
- [ ] check pugz&producer and writer&pigz part
- [ ] inline query function by ğŸ‘‹
- [ ] fix pugz size bugï¼Ÿï¼Ÿ
- [ ] make pigz not flush to disk
- [ ] 

## 0908

æ·¦ä¹‹å‰å†™çš„infoæ•´ä¸è§äº†ï¼Œéº»äº†ã€‚

| version                                               | total  | hdf5  | others |      |      |
| ----------------------------------------------------- | ------ | ----- | ------ | ---- | ---- |
| init                                                  | ï½1100 | ï½100 | ï½1000 |      |      |
| add rabbitio from rabbitqc                            | 750    | 100   | 650    |      |      |
| no gz                                                 | 386    | 100   | 286    |      |      |
| no gz && replace std::unordered_map to robin_hood::xx | 220    | 50    | 170    |      |      |
| no gz && use list hash                                | 179    | 28    | 151    |      |      |
| use list hash                                         | 500    | 29    | 191+x  |      |      |

//TODO ä¸ºäº†è¿‡ç¼–è¯‘æŠŠboostéƒ¨åˆ†æ¶‰åŠåˆ°mapçš„æ“ä½œåšäº†å¤åˆ¶ï¼Œè¿˜æœ‰ææ„çš„æ—¶å€™swapéƒ½æ³¨é‡Šæ‰äº†

## 0909

ç›®å‰å…ˆæææ¶ˆè´¹è€…å§ï¼Œå…ˆä¸æ•´gzï¼Œè®©è¯»å’Œå†™çº¿ç¨‹ä¸ä¼šæ˜¯ç“¶é¢ˆã€‚ä¸Šé¢æ˜¯ç®€å•æŠŠmapæ¢äº†ï¼Œæ¢å‰åéƒ½èƒ½æ‹‰èµ·æ¥64çº¿ç¨‹ï¼Œè¯´æ˜æ¶ˆè´¹è€…è¿˜æœ‰æå‡ç©ºé—´ï¼Œä»Šå¤©å‡†å¤‡è¯•è¯•é“¾å¼hashï¼Œæ„Ÿè§‰æ€è·¯å’Œä¸»åŠæ–¹ç»™çš„äºŒçº§ç´¢å¼•åº”è¯¥å·®ä¸å¤šã€‚

ç¡®å®æœ‰ç‚¹å­æå‡ï¼Œä½†æ˜¯æ²¡æœ‰ç‰¹åˆ«å¿«ï¼Œæ›´æ–°ğŸ‘†ã€‚

å†™çš„æ—¶å€™æœ‰ç‚¹å­å°å°çš„bugï¼ŒåŸºç¡€ä¸ç‰¢åœ°åŠ¨å±±æ‘‡å•Šï¼Œæœ¬æ¥ä»¥ä¸ºä¼ æŒ‡é’ˆè¿›å»å°±ä¸ç”¨&äº†ï¼Œä½†ä¹‹å‰çš„ç”¨æ³•éƒ½æ˜¯ä¿®æ”¹æŒ‡é’ˆæŒ‡å‘çš„ç©ºé—´é‡Œé¢çš„ä¿¡æ¯ï¼Œè¿™å¯ä»¥ä¸ç”¨&ï¼Œä½†æ˜¯ä»Šå¤©å±äºæ˜¯ç›´æ¥è¯¥æŒ‡é’ˆçš„å€¼äº†ã€‚

## 0910

å¥½åƒå¬è¯´å¹¶è¡Œæ–‡ä»¶ç³»ç»Ÿæ¯æ¬¡å†™æ³¢åŠ¨å¤ªå¤§ï¼Œå¼€æ”¾äº†è®¡ç®—èŠ‚ç‚¹ä¸Šçš„userç›®å½•ï¼Œè¿™é‡Œç®€å•æµ‹æµ‹å¯¹æˆ‘ä»¬æœ‰æ²¡æœ‰å½±å“ï¼š

|                                                       |                 |
| ----------------------------------------------------- | --------------- |
| Use list hash                                         | 499+500+510+500 |
| no gz ğŸ‘†                                               | 193+189+191     |
| no gz icpc  -Ofast -xHost -qopt-zmm-usage=high        | 192             |
| no gz g++  -Ofast -funroll-loops -flto  -march=native | 186+188         |
| gz   g++  -Ofast -funroll-loops -flto  -march=native  | 530+544         |

ç›®å‰è¯»å†™gzå¤§çº¦åªèƒ½ç”¨èµ·30ä¸ªæ ¸å¿ƒï¼Œæ¯”èµ·ä¹‹å‰çš„50ä¸ªæ ¸å¿ƒæœ‰äº†ä¸€å®šçš„æå‡ã€‚

ç®€å•æ¢ä¸€ä¸ªgccç‰ˆæœ¬å’Œicpcè¯•è¯•ï¼Œä½†æ˜¯ç¼–è¯‘çš„æ—¶å€™æŠ¥é”™äº†ï¼Œåˆæ­¥çŒœæµ‹æ˜¯ç¼–è¯‘å¥½çš„hdf5å’Œbooståº“æ˜¯ç”¨çš„gcc4ï¼Œç›¸å·®å¤ªå¤šä¸èƒ½ç”¨ï¼Œç”¨gcc7é‡æ–°æä¸€ä»½ã€‚

## 0911

æ²¡å•¥ç”¨å•Šï¼Œç”¨gcc7ç¼–è¯‘çš„boostè¿˜æ˜¯æŠ¥é”™ï¼Œå¹¶ä¸”æ‰¾äº†ä¸ªç®€å•çš„ä¾‹å­ï¼Œä¹Ÿè¿˜æ˜¯æŠ¥é”™ï¼Œç›®å‰çŒœæµ‹å°±æ˜¯gcc7å’Œgcc11è‡ªå·±å®‰è£…çš„æ—¶å€™å°‘äº†ä»€ä¹ˆæ­¥éª¤ã€‚ç°åœ¨çš„å†…å­˜ä½¿ç”¨å¤§çº¦æ˜¯list hash mapå°±ç”¨äº†10.5Gå·¦å³ï¼Œç„¶ååé¢æ•´ä¸ªæ¶ˆè´¹è€…ä»¬åœ¨ç”¨3Gå·¦å³ï¼Œå¦‚æœå†™gzçš„è¯ä¼šæ¥ä¸åŠå‹ç¼©å¯¼è‡´ç§¯å‹åœ¨å†…å­˜é‡Œï¼Œèƒ½åˆ°20Gä»¥ä¸Šã€‚

ç®€å•æ¢äº†ä¸€ä¸‹ç¼–è¯‘å™¨å’Œç¼–è¯‘å‚æ•°ï¼ŒupdateğŸ‘†ã€‚

å¤šå¤šå°‘å°‘æœ‰ç‚¹ç”¨å§å¯èƒ½ã€‚

ä»Šå¤©è¿™æœºå™¨ä¸å¤§è¡Œå•Šã€‚

cï¼Œzzåˆ«å¼€ç®±å­äº†å¯ã€‚

## 0912

ä»Šå¤©çœ‹äº†çœ‹pugzï¼Œå…·ä½“åŸç†emmmè®ºæ–‡å¤ªé•¿äº†å±å®æ˜¯è¯»ä¸ä¸‹å»ï¼Œæ”¹å¤©å»å›¾ä¹¦é¦†æ…¢æ…¢çœ‹å§ã€‚

ç¨å¾®ä¿®æ”¹äº†ä»£ç ï¼Œå¥½åƒå¤šçº¿ç¨‹ç°åœ¨å°±æ˜¯æµå¼å¤„ç†çš„ï¼Ÿï¼Ÿï¼ŸæŠŠåŸæ¥wite to stdoutæ”¹æˆäº†to fileï¼Œå»shmä¸‹ç®€å•æµ‹äº†æµ‹æ€§èƒ½ï¼ŒåŸºæœ¬ä¸Š8çº¿ç¨‹èƒ½åˆ°30sä»¥ä¸‹ï¼Œéå¸¸ä¸é”™ç¬¦åˆèµ›é¢˜çš„è¦æ±‚ï¼Œç°åœ¨å†æµ‹æµ‹ç›´æ¥æŠŠ20Gçš„ç©æ„æ•´åˆ°å†…å­˜é‡Œçœ‹çœ‹å’‹æ ·ã€‚

## 0913

æ„Ÿè§‰pugzä¹Ÿä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥æµå¼å¤„ç†ï¼Œç®€å•åŠ åˆ°äº†å†³èµ›é¢˜é‡Œé¢

|                                      | Total |      |
| ------------------------------------ | ----- | ---- |
| add pugz (one thread), in gz, out fq | 187   |      |
| Submit4, in gz, out fq               | 216   |      |
|                                      |       |      |

å•çº¿ç¨‹çš„è¯è¦æ¯”æ™®é€šçš„è§£å‹ç¼©å¥½ä¸€ç‚¹ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ç›´æ¥pugzå•çº¿ç¨‹å’Œgunzipé‚£æ ·æ˜æ˜¾ï¼Œè€Œä¸”ç°åœ¨å¤šçº¿ç¨‹ä¼šå‡ºç°é”™è¯¯ï¼Œå³è§£å‹å‡ºæ¥çš„ä¸¤å—å¤§å°è™½ç„¶ä¸€æ ·ä½†æ˜¯é‡Œé¢çš„å›è½¦ä¸ä¸€æ ·å¤šã€‚ã€‚ã€‚ã€‚

## 0914

giao

ConcurrentQueueä¸æ˜¯æœ‰åºçš„ï¼Œéº»äº†ã€‚æ¢æˆäº†åŒä¸€ä¸ªäººæå¾—ReaderWriterQueueï¼Œä¸€å¯¹ä¸€ï¼Œç°åœ¨èƒ½è¿‡checkäº†ï¼Œç®€å•æµ‹è¯•ä¸€ä¸‹ï¼š

|                           | insert | pugz1/pugz2/producer/consumer/total | run use number of consumer             |      |
| ------------------------- | ------ | ----------------------------------- | -------------------------------------- | ---- |
| init in gz out fq         | 24     | x/x/189/190/214                     | <30 ~28                                |      |
| pugz thread1 in gz out fq | 23     | 140/140/158/160/190                 | ä¸ç¨³å®šï¼Œæœ‰æ—¶å€™èƒ½åˆ°30å¤šï¼Œå¤§éƒ¨åˆ†æ—¶é—´50å¤š |      |
| pugz thread2 in gz out fq | 27     | 130/140/160/170/190                 | ğŸ‘†                                      |      |
|                           |        |                                     |                                        |      |
|                           |        |                                     |                                        |      |
|                           |        |                                     |                                        |      |
|                           |        |                                     |                                        |      |

æ„Ÿè§‰æ•ˆæœä¸€èˆ¬å•Šï¼Œè€Œä¸”è¿è¡Œä»–ç»™çš„gzæ–‡ä»¶è¿˜è€æ˜¯å‡ºé”™ã€‚ã€‚ã€‚ã€‚è‡ªå·±é‡æ–°å‹ç¼©äº†ä¸¤ä¸ªgzï¼ˆä¸€ä¸ªè¦åŠå°æ—¶ï¼Œï¼Œï¼Œï¼Œæ·¦ï¼‰

|                               | pugz1/pugz2/producer/consumer/total |      |
| ----------------------------- | ----------------------------------- | ---- |
| no process gz in no outï¼Œinit | x/x/185/190/210                     |      |
| ğŸ‘†ï¼Œpugz thread 1              | 46/50/46/50/75                      |      |
| ğŸ‘†ï¼Œpugz thread 2              | 35/37/35/37/62                      |      |
| ğŸ‘†ï¼Œpugz thread 4              | 30/33/52/53/78                      |      |
| ğŸ‘†ï¼Œpugz thread 8              | 31/30/56/59/84                      |      |

è™½ç„¶ä¸¤ä¸ªçº¿ç¨‹æœ€å¥½æœ‰ç‚¹å­å¥‡æ€ªï¼Œä½†æ˜¯åŸºæœ¬ä¸Šæ—¶é—´è¿˜æ¯”è¾ƒåˆç†ï¼Œä½†æ˜¯ä¸åŠ no processçš„è¯è¦è·‘100+sï¼Œä¸å¤ªåˆç†ã€‚

## 0915

|                                   |      |            | producer   | consumer | total |
| --------------------------------- | ---- | ---------- | ---------- | -------- | ----- |
| in gzï¼Œout fq                     | 12G  | ï½3500%    | 187        | 190      | 214   |
| pugz thread2ğŸ‘†                     | 35G  | >6000%     | 153(100)   | 160      | 190   |
| pugz thread4ğŸ‘†                     | x    | ä¸ç¨³å®šã€‚ã€‚ | x          | x        | x     |
| dataPool 1024,dataQueue 2048 init | 13G  | ï½3000%    | 189        | 190      | 218   |
| pugz thread2ğŸ‘†                     | 30G  | ä¸ç¨³å®š     | 150        | 180      | 204   |
| in fqï¼Œout fq                     | 17G  | ï½6400%    | 144        | 160      | 188   |
| real data init                    | 12G  | ï½3500%    | 189        | 190      | 218   |
| real data 128/500 pugz thread2    | <30G | ï½6000%    | 157ï¼ˆ120ï¼‰ | 160      | 190   |
|                                   |      |            |            |          |       |

æŠŠdataPoolå’ŒdataQueueå¼„å¤§äº†ä¹Ÿæ²¡å•¥ç”¨ã€‚

è¡¨é‡Œé¢çš„ç”Ÿäº§è€…æ—¶é—´å…¶å®ä¹Ÿæ²¡æœ‰å¤ªå¤§çš„å‚è€ƒä»·å€¼ï¼Œå› ä¸ºå¯èƒ½æ¶ˆè´¹è€…å¤ªæ…¢æŠŠdataQueueå µä½äº†ï¼Œç”Ÿäº§è€…åœ¨ç­‰å¾…ï¼›å¯ä»¥å‘ç°initè¯»gzçš„æ—¶å€™På’ŒCçš„æ—¶é—´åŸºæœ¬ä¸€æ ·ï¼Œè¿™é‡Œåº”è¯¥æ˜¯Cåœ¨ç­‰Pï¼ŒPæå‡ºæ¥æœ€åä¸€å—æ•°æ®Cå¤„ç†å®Œå°±éƒ½ç»“æŸäº†ï¼Œè€Œè¯»fqæˆ–è€…pugzçš„è¯På’ŒCçš„æ—¶é—´æœ‰ä¸€ç‚¹å·®è·ï¼Œåº”è¯¥æ˜¯Cå¤ªæ…¢ï¼Œqueueæ»¡äº†ï¼ŒPä¸­é—´ç­‰å¾…äº†ï¼Œæœ€åPæå®Œé˜Ÿåˆ—é‡Œè¿˜æœ‰äº›æ•°æ®ï¼Œç„¶åCå¤„ç†å®Œã€‚



## 0916

æœ€è¿‘ä»Šå¤©å±äºæ˜¯è„‘å­ä¸å¤ªæ¸…é†’ï¼Œæ•´ä¸æ˜ç™½ä¸ºå•¥æ¶ˆè´¹è€…å¤šç”¨äº†æ¥è¿‘ä¸€å€ä½†æ˜¯æ—¶é—´æ²¡å’‹å˜ï¼Ÿ

ä»Šå¤©å…ˆèµ¶èµ¶è¿›åº¦ï¼ŒæŠŠbgzipåŠ ä¸Šï¼Œè¦ä¸å‹ç¼©å¤ªæ…¢äº†ï¼Œæ˜¨å¤©åœ¨fatä¸Šè¯•äº†è¯•ï¼Œbgzipå‹ç¼©å‡ºæ¥çš„gzæ–‡ä»¶gunzipæ˜¯å¯ä»¥è¯»çš„ï¼Œä½†æ˜¯pugzä¸æ”¯æŒã€‚

ä¸‹é¢æµ‹è¯•ä¸€ä¸‹ï¼Œè¾“å‡ºåˆ°/dev/shm

| Unzip           | p1.fq |      |
| --------------- | ----- | ---- |
| unpigz thread 1 | 83    |      |
| unpigz thread 2 | 66    |      |
| unpigz thread 4 | 66    |      |
| unpigz thread 8 | 66    |      |
| pugz thread 1   | 59    |      |
| pugz thread 2   | 40    |      |
| pugz thread 4   | 27    |      |
| gunzip          | 150   |      |

| Zip               | p1.fq  |      |
| ----------------- | ------ | ---- |
| pigz thread 1     | >1800  |      |
| pigz thread 2     | ï½1000 |      |
| pigz thread 4     | ï½500  |      |
| pigz thread 8     | ï½250  |      |
| gzip              | ~1800  |      |
| bgzip thread 1 -1 | 400    |      |
| bgzip thread 2 -1 | 200    |      |
| bgzip thread 4 -1 | 100    |      |
| bgzip thread 8 -1 | 52     |      |
| 16                | 26     |      |
|                   |        |      |
| pigz thread 1 -4  | 420    |      |
| pigz thread 2 -4  | 210    |      |
| pigz thread 4 -4  | 105    |      |
| pigz thread 8 -4  | 53     |      |
| pigz thread 16 -4 |        |      |
| gzip -4           | 450ï½  |      |
| bgzip thread 1 -4 | 240    |      |
| bgzip thread 2 -4 | 120    |      |
| bgzip thread 4 -4 | 60     |      |
| bgzip thread 8 -4 | 32     |      |
|                   |        |      |
|                   |        |      |

æœ‰ç‚¹å¥‡æ€ªä¸ºå•¥ä»£ç é‡Œé¢çš„gzwriteå‹ç¼©èµ·æ¥é‚£ä¹ˆå¿«ï¼Ÿ

## 0917

æ·¦ï¼Œä»£ç é‡Œé¢æ˜¯-4ï¼Œåªå°±ç”¨gzipæˆ–è€…pigz -4ä¹Ÿå¾ˆå¿«ï¼Œè€Œä¸”ç®€å•æµ‹è¯•ä¹‹åå‘ç°pigzçš„çº¿ç¨‹åŠ é€Ÿæ¯”è¿˜æ˜¯æŒºå¥½çš„ï¼›è€Œbgzipä½œä¸ºåˆ†å—å‹ç¼©ä¼¼ä¹æ¯”pigzæ•ˆæœæ›´å¥½ï¼Œä½†æ˜¯pugzæ²¡æ³•å¤„ç†bgzipå‹ç¼©å‡ºæ¥çš„gzæ–‡ä»¶ï¼Œpugzå¯ä»¥ç”¨ä¸¤ä¸ªçº¿ç¨‹å¤„ç†pigzå‹ç¼©å‡ºæ¥çš„æ–‡ä»¶ï¼ˆ//TODO çº¿ç¨‹æ•°å¤šçš„æ—¶å€™å¯èƒ½ä¼šæŠ¥é”™ï¼‰ã€‚

ç»¼ä¸Šï¼Œç»¼åˆè€ƒè™‘é€Ÿåº¦å¯æ˜“ç”¨æ€§ï¼Œå‡†å¤‡ä½¿ç”¨pugzè¿›è¡Œå¤šçº¿ç¨‹çš„è§£å‹ç¼©ï¼ˆè¿™ä¸ªå¯ä»¥æ­£å¸¸å¤„ç†gzipå‹ç¼©å‡ºæ¥çš„æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ä¸¤ä¸ªçº¿ç¨‹//TODOå¤„ç†pigzå‹ç¼©å‡ºæ¥çš„æ–‡ä»¶ï¼Œä½†æ˜¯æ— æ³•å¤„ç†bgzipå‹ç¼©å‡ºæ¥çš„æ–‡ä»¶---åªä¼šè§£å‹ç¬¬ä¸€å—ï¼‰ï¼Œç„¶åä½¿ç”¨pigzè¿›è¡Œå‹ç¼©ï¼ˆè¿™æ ·å‹ç¼©å‡ºæ¥çš„æ–‡ä»¶åˆ°ä¸‹ä¸€ä¸ªæµç¨‹ä½¿ç”¨æ™®é€šçš„gunzipå®Œå…¨å¯ä»¥ï¼Œä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„ä»£ç å¼€ä¸¤ä¸ªçº¿ç¨‹è¯»ä¹Ÿæ˜¯å¯ä»¥çš„ï¼‰ã€‚

## 0918

è§£å°äº†èŠœæ¹–

|                             |      |         |            |      |      |
| --------------------------- | ---- | ------- | ---------- | ---- | ---- |
| in gz                       | 12G  | ï½3500% | 189        | 190  | 218  |
| in gzï¼Œpugz thread 2        | <30G | ï½6000% | 157ï¼ˆ120ï¼‰ | 160  | 190  |
| /users in gz                | 12G  | ï½3500% | 190        | 190  | 219  |
| /users in gzï¼Œpugz thread 2 | <30G | ï½6000% | 157ï¼ˆ120ï¼‰ | 160  | 190  |
| /users in gzï¼Œpugz thread 1 | <30G | >6000%  | 151ï¼ˆ120ï¼‰ | 160  | 183  |
| /users in fq                |      |         |            |      |      |

ç»™pugzå’Œproducerä¹‹é—´çš„queueåŠ ä¸ªå¤§å°é™åˆ¶å§ã€‚

æ·¦ å¥½åƒæ­»é”äº†ã€‚ã€‚ã€‚ã€‚

## 0919

æœªæ›¾è®¾æƒ³è¿‡çš„é”™è¯¯ï¼Œï¼Œï¼Œï¼Œsleepå•ä½å±…ç„¶æ˜¯sï¼Œæˆ‘æ€ä¹ˆè®°å¾—ä¹‹å‰ç”¨çš„éƒ½æ˜¯mså•Šã€‚ã€‚ã€‚ç„¶åé˜Ÿåˆ—1æ»¡äº†çš„æ—¶å€™pugzçº¿ç¨‹å°±å¼€å§‹äº†é•¿è¾¾1000sçš„æ²‰ç¡ã€‚ã€‚ã€‚ã€‚

æ”¹æˆusleepä¹‹åæœ‰åŠ äº†ä¸ªproducerç»“æŸçš„tagï¼Œå¦‚æœproducerç»“æŸäº†pugzçº¿ç¨‹å°±åœæ­¢è§£å‹äº†ã€‚

|                                             |      |                  |                 |      |      |
| ------------------------------------------- | ---- | ---------------- | --------------- | ---- | ---- |
| in gzï¼Œpugz thread 2ï¼Œqueue 128*128         | <18G | ï½6000%          | 157ï¼ˆ150ï¼Œ157ï¼‰ | 160  | 192  |
| in gzï¼Œpugz thread 1ï¼Œqueue 128*128         | <18G | ï½6000%          | 157ï¼ˆ150ï¼Œ157ï¼‰ | 160  | 192  |
| get map and pugz same time thread 1         | <18G | >6000%           | 180 180 180     | 180  | 187  |
| get map and pugz same time thread 1         | <18G | >6000%           | 180 180 190     | 190  | 197  |
| queue1ï¼š1<<20ï¼Œin gzï¼Œout gzï¼Œpugz thread 1 | ~60G | 6400->5000->6400 | 186 89 94       | 189  | 191  |

å‘ç°å¼€å§‹çš„å‡ ç§’ä¼¼ä¹çº¿ç¨‹éƒ½ç”¨ä¸èµ·æ¥ï¼Œåº”è¯¥æ˜¯Påœ¨ç­‰pugzï¼Œè¿™å—æ—¶é—´å¯ä»¥å…ˆç®€å•çš„å’Œhashmap insertæ”¾åˆ°ä¸€å—ï¼Œåæ­£äº’ä¸å½±å“ã€‚

//TODO æŠŠqueue1å¼€çš„å¤§ä¸€ç‚¹æ–¹ä¾¿ä¸€å¼€å§‹æ©ç›–pugzçš„æ—¶å€™èƒ½é¢„å¤„ç†å‡ºæ›´å¤šçš„å—ã€‚

//TODO ä¿®æ”¹pugzæ¯ä¸€å—çš„å¤§å°

//TODO ç»™queue1æ”¹æˆä¸€ä¸ªå†…å­˜æ± ï¼Œå‡å°‘newå’Œdelete

å¥½å•Šï¼ŒåŸºæœ¬ä¸Šç”Ÿäº§è€…ä»¬æå¾—å¤§ä½“å·®ä¸å¤šäº†ï¼ˆPå’Œpugzï¼‰ï¼Œç°åœ¨æä¸€ä¸‹writeã€‚

|                                             |      |              |             |      |      |
| ------------------------------------------- | ---- | ------------ | ----------- | ---- | ---- |
| ğŸ‘† pugz thread 1ï¼Œin gzï¼Œout gz              | 30G  | 4000%ï½5000% | 204 200 210 | 210  | 566  |
| ğŸ‘† pugz thread 2ï¼Œin gzï¼Œout gz              | 30G  | 4000%ï½5000% | 204 200 210 | 210  | 566  |
| queue1ï¼š1<<20ï¼Œin gzï¼Œout gzï¼Œpugz thread 1 | <60G | ï½5000%      | 197 90 90   | 198  | 530  |
| queue1ï¼š1<<20ï¼Œin gzï¼Œout gzï¼Œpugz thread 2 | <60G | ï½6000%      | 194 57 62   | 195  | 538  |
|                                             |      |              |             |      |      |
|                                             |      |              |             |      |      |

## 0920

ç®€å•çœ‹äº†çœ‹pigzçš„æ–‡æ¡£ï¼Œæ²¡æœ‰apiä½†æ˜¯stack overflowé‡Œé¢æœ‰ä¸€ä¸ªpigzçš„å¼€å‘è€…å›ç­”çš„é—®é¢˜ï¼Œè¯´æ˜¯è¦æ”¯æŒpipeï¼Œçœ‹æ›´æ–°æ—¥å¿—å¤§çº¦å›ç­”è¿™ä¸ªé—®é¢˜ä¸¤ä¸ªæœˆä¹‹åpigzçœŸçš„åŠ äº†è¿™å—åŠŸèƒ½ï¼Œä½†æ˜¯ç¨å¾®çœ‹äº†çœ‹å‚æ•°æ²¡æ‰¾åˆ°å’‹ç”¨ã€‚ã€‚ã€‚è¿˜æ˜¯ç›´æ¥æ”¹ä»£ç å§ã€‚

æŠŠpigzåŠ åˆ°å†³èµ›çš„ä»£ç é‡Œï¼ˆç›´æ¥æŠŠpigz.cå¤åˆ¶åˆ°multi.cppé‡Œé¢çš„ï¼Œå¾ˆä¸‘é™‹ã€‚ã€‚ã€‚ã€‚ç„¶åæ”¹äº†yarn.hä¸­çš„å…³é”®å­—ï¼Œç„¶åæŠŠ.hæ–‡ä»¶éƒ½åŠ äº†extren Cï¼ŒæŠŠcomliain(x,...)ç»™æ³¨é‡Šäº†ï¼Œå‹‰å¼ºå¯ä»¥è¿è¡Œäº†ï¼‰

ç°åœ¨ç®€å•æµ‹è¯•ä¸€ä¸‹ï¼Œå…ˆç”¨åŸæ¥çš„writeæŠŠfqå†™åˆ°ç¡¬ç›˜ä¸Šï¼Œå†ç”¨å¼€ä¸ªçº¿ç¨‹ç”¨pigzå‹ç¼©ã€‚

|                                                   |               |               |           |         |      |
| ------------------------------------------------- | ------------- | ------------- | --------- | ------- | ---- |
| add pigz thread 2ï¼Œin gzï¼Œout gzï¼Œpugz thread 1ğŸ‘†  | <60G          | ï½5000%/6400% | 193 90 95 | 196+242 | 443  |
| add pigz thread 16ï¼Œin gzï¼Œout gzï¼Œpugz thread 1ğŸ‘† | <60G          | ï½6000%/6400% | 191 90 95 | 195+47  | 244  |
| add pigz thread 32ï¼Œin gzï¼Œout gzï¼Œpugz thread 2ğŸ‘† | <60Gï¼ˆï½50Gï¼‰ | ï½6000%/6400% | 191 55 59 | 195+39  | 238  |
| add pigz thread 64ï¼Œin gzï¼Œout gzï¼Œpugz thread 2ğŸ‘† | <60Gï¼ˆï½50Gï¼‰ | ï½6000%/6400% | 184 55 59 | 188+30  | 219  |

## 0921 

```
rm -rf combine_read.fq && rm -rf combine_read.fq.gz && ../ST_BarcodeMap-0.0.1 --in DP8400016231TR_D1.barcodeToPos.h5 --in1 V300091300_L03_read_1.fq.gz  --in2 V300091300_L04_read_1.fq.gz --out combine_read.fq --mismatch 2 --thread 64 --usePugz --pugzThread 2 --usePigz --pigzThread 32
```

```c++
		int th_num = mOptions->pigzThread;
    printf("th num is %d\n", th_num);
    string th_num_s = to_string(th_num);
    printf("th num s is %s\n", th_num_s.c_str());
    printf("th num s len is %d\n", th_num_s.length());

    infos[2] = new char[th_num_s.length() + 1];
    memcpy(infos[2], th_num_s.c_str(), th_num_s.length());
```

è¿™æ®µä»£ç å¥½åƒemmmï¼Œchar*åé¢æ‰¾ä¸åˆ°ç»“æŸç¬¦ï¼Œç”¨çš„æ—¶å€™å°±å¯èƒ½å‡ºé—®é¢˜ï¼Œç°åœ¨çš„ç­–ç•¥æ˜¯å†åŠ ä¸€å¥

```c++
infos[2][th_num_s.length()] = '\0';
```

æ„Ÿè§‰ä¸å¤ªä¼˜é›…ã€‚

update table ğŸ‘†

## 0922

åŸæ¥çš„pigzä»£ç é‡ŒåŒ…æ‹¬äº†è¾“å…¥æ–‡ä»¶xx.fqæ˜¯å¦å­˜åœ¨çš„æ£€æŸ¥ï¼Œç°åœ¨åªèƒ½æ˜¯æŠŠoutå‚æ•°çš„xx.fq.gzæ”¹æˆxx.fqï¼Œç”¨æºä»£ç writerçš„new ofstreamç”Ÿæˆä¸€ä¸ªç©ºçš„xx.fqæ¬ºéª—ä¸€ä¸‹pigzï¼ˆ5000è¡Œä»£ç æ˜¯åœ¨ä¸æƒ³åŠ¨ï¼‰ã€‚

ç„¶åç°åœ¨åœ¨writerå’Œpigzä¹‹é—´åŠ äº†ä¸€ä¸ªqueueï¼Œå¤§å°è¿˜æ˜¯1<<20ï¼ŒæŠŠpigzçš„å—å¤§å°æ”¹æˆäº†4Mã€‚

|                                             |      |               | producer(pugz) | comsumer(pigz) | total |
| ------------------------------------------- | ---- | ------------- | -------------- | -------------- | ----- |
| no more disk write and readï¼Œpugz 2ï¼Œpigz 4 | ~60G | ï½5000%/6400% | 195 61 66      | 198 201        | 201   |
| no more disk write and readï¼Œpugz 2ï¼Œpigz 2 | ~60G | ï½5000%/6400% | 193 62 67      | 194 283        | 294   |
| no more disk write and readï¼Œpugz 1ï¼Œpigz 4 | ~60G | ï½5000%/6400% | 183 95 100     | 187 189        | 190   |
| ğŸ‘†pigz block size 8Mï¼Œpugz 1ï¼Œpigz 4         | ~60G | ï½5000%/6400% |                |                | 203   |

è¿™ä¸ªæµ‹å¾—æ—¶é—´æœ‰ç‚¹å­æ³¢åŠ¨ã€‚ã€‚ã€‚ç®—äº†å…ˆä¸ç®¡äº†ï¼Œåæ­£å¤§ä½“ä¸Šï¼Œå•ç‹¬æµ‹è¯•çš„è¯å‹ç¼©å’Œè§£å‹ç¼©å¤§çº¦30så·¦å³ï¼Œåœ¨ç¨‹åºé‡Œæµ‹è¯•çš„è¯å‹ç¼©å¤§çº¦60sï¼Œè§£å‹ç¼©16ä¸ªçº¿ç¨‹ä¹Ÿèƒ½60sä»¥å†…ï¼Œä½†æ˜¯ç°åœ¨æ¶ˆè´¹è€…è€—æ—¶è¿œé«˜äº60sï¼Œå¯ä»¥å…ˆæŠŠé‡ç‚¹è½¬ç§»åˆ°æ¶ˆè´¹è€…ä¸Šäº†ã€‚

ç®€å•åˆ†æäº†ç°åœ¨çš„hash mapï¼Œä¸€å…±2.6e8ä¸ªå…ƒç´ ï¼Œmodæ˜¯1e9+7ï¼Œæœ‰2e8ä¸ªæ˜¯ä¸å†²çªçš„ï¼Œæ‰€ä»¥modå–è¿™ä¹ˆå¤§çš„æƒ…å†µä¸‹å¹¶ä¸éœ€è¦åœ¨é“¾è¡¨è¿™é‡Œåšä»€ä¹ˆæ“ä½œã€‚ä½†æ˜¯åŒæ ·çš„ï¼Œå†…å­˜éœ€æ±‚ä¹Ÿæ˜¯å¾ˆå¤§çš„ï¼Œç›´æ¥çš„hashè¡¨å¤§çº¦å 3Gï¼Œåé¢é“¾è¡¨å­˜å‚¨çš„2.6e8ä¸ªint64å¤§çº¦å 4Gã€‚

æ¢å‡ ä¸ªmodè¯•è¯•ï¼šï¼ˆç®€å•çš„è¯»fqå†™fqï¼‰

|            |       |       | get map |         |      |
| ---------- | ----- | ----- | ------- | ------- | ---- |
| 1e9+7      | ï½12G | 6400% | 27      | 169 174 | 175  |
| 73939133   | ï½10G | 6400% | 40      | 512 529 | 529  |
| 1073807359 | ï½13G | 6400% | 26      | 165 169 | 170  |
| 2000000011 | ï½17G | 6400% | 30      | 171 176 | 176  |
|            |       |       |         |         |      |

å¥½å•Šï¼Œæ²¡å•¥ç”¨æ„Ÿè§‰ï¼Œæ¯•ç«Ÿ1e9+7çš„æ—¶å€™å°±æœ‰80%å·¦å³çš„å…ƒç´ hashæ˜¯æ²¡æœ‰å†²çªçš„ï¼Œç„¶å10%åªå†²çªä¸€æ¬¡ï¼Œä»¥æ­¤ç±»æ¨ã€‚

ç„¶ååšgetPositionä¹‹å‰å…¶å®å¯ä»¥æ ¹æ®åŸæ¥ä»£ç çš„é€»è¾‘å…ˆå¯¹umiåšä¸€ä¸‹filterï¼Œå¦‚æœæ²¡æœ‰é€šè¿‡é‚£ä¹ˆgetPositionä¹Ÿå¯ä»¥ç›´æ¥ä¸åšäº†ã€‚æ·¦ä»–è¦ç»Ÿè®¡mMapToSlideReadè¿™å˜é‡ï¼Œï¼Œï¼Œï¼Œæ‰€ä»¥è¿™ç§æ–¹å¼ä¸èƒ½ç”¨ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚GG

|                                             |      |               | producer(pugz) | comsumer(pigz) | total |
| ------------------------------------------- | ---- | ------------- | -------------- | -------------- | ----- |
| no more disk write and readï¼Œpugz 1ï¼Œpigz 4 | ~60G | ï½5000%/6400% | 183 95 100     | 187 189        | 190   |
| ğŸ‘† use 1073807359                            | ~60G | ï½5000%/6400% | 180 85 91      | 183 183        | 185   |
|                                             |      |               |                |                |       |
|                                             |      |               |                |                |       |
|                                             |      |               |                |                |       |

//TODO æŠŠbarcodeç¼©ä¸€ä¸‹èŒƒå›´ç›´æ¥æä¸ªæ•°ç»„æ¥æµ‹æµ‹è·‘å¤šä¹…ã€‚

æ™šä¸Šè·‘å®Œæ­¥çªç„¶å¬åˆ°å¤§å¸ˆå…„é—®çº¿ç¨‹åŠ é€Ÿæ¯”å’‹æ ·ï¼Œemmmå¥½é—®é¢˜ã€‚

ç®€å•æµ‹æµ‹

|                          |      |        | getmap/producer | comsumer | total |
| ------------------------ | ---- | ------ | --------------- | -------- | ----- |
| in fqï¼Œout fqï¼Œthread 64 | 14G  | 6400%  | 26/165          | 170      | 170   |
| in fqï¼Œout fqï¼Œthread 32 | 13G  | 3200%+ | 29/201          | 206      | 200   |
| in fqï¼Œout fqï¼Œthread 16 | 12G  | 1600%+ | 26/315          | 323      | 324   |
| in fqï¼Œout fqï¼Œthread 8  | 11G  | 800%+  | 26/582          | 597      | 590   |
| in fqï¼Œout fqï¼Œthread 4  | 11G  | 400%+  | 26/1146         | 1175     | 1150  |
| in fqï¼Œout fqï¼Œthread 2  |      |        | 30/2323         | 2384     | 2384  |
| in fqï¼Œout fqï¼Œthread 1  |      |        | 29/4046         | 4149     | 4149  |

æŒ‰ç…§ä¹‹å‰qcä½¿ç”¨c++ threadåº“å®ç°P-Cæ¨¡å‹çš„ç»éªŒæ¥çœ‹ï¼Œä¸€èˆ¬åªè¦cpuè·‘èµ·æ¥äº†ä¸¤å€çš„çº¿ç¨‹ï¼Œé€Ÿåº¦å°±æ˜¯ä¸¤å€ï¼Œä½†ç°åœ¨çº¿ç¨‹åŠ é€Ÿæ¯”ä¸å¤Ÿå¥½ï¼Œåˆæ­¥çŒœæµ‹æ˜¯ä¼ªå…±äº«æˆ–è€…remote numaè®¿å­˜æ•ˆç‡ä½çš„åŸå› ï¼Œå¯¹äºnumaæ¶æ„ç®€å•å­¦ä¹ äº†ä¸€ä¸‹ï¼š

https://zhuanlan.zhihu.com/p/62795773

ç®€å•è¯´å°±æ˜¯æé«˜è®¿é—®å†…å­˜çš„æ•ˆç‡ï¼Œâ¬†ï¸æ–‡ä¸­æåˆ°äº†å†…å­˜éœ€æ±‚å¾ˆå¤§ï¼Œè¶…è¿‡ä¸€ä¸ªnumaèŠ‚ç‚¹å¯¹åº”å†…å­˜çš„æ—¶å€™é¢‘ç¹swapå¸¦æ¥é—®é¢˜ï¼Œç°åœ¨ä»£ç é‡Œé¢çš„æƒ…å†µåº”è¯¥ç•¥æœ‰ä¸åŒï¼Œæ˜¯ä¸¤ä¸ªnumaèŠ‚ç‚¹çš„coreéƒ½ç”¨èµ·æ¥äº†ï¼Œä½†æ˜¯å­˜å‚¨å…³é”®ä¿¡æ¯çš„hashmapåªåœ¨æŸä¸ªèŠ‚ç‚¹çš„å†…å­˜ä¸Šï¼Œè¿™æ ·æœ‰ä¸€åŠcoreåœ¨è®¿å­˜çš„æ—¶å€™ä¼šæ¯”è¾ƒæ…¢ã€‚ç®€å•æƒ³åˆ°çš„è§£å†³åŠæ³•å°±æ˜¯åœ¨å¦ä¸ªnumaèŠ‚ç‚¹å¯¹åº”çš„å†…å­˜é‡Œå¼€ä¸€ä¸ªhashmapçš„å‰¯æœ¬ï¼Œé‚£ä¸ªèŠ‚ç‚¹è®¿é—®è‡ªå·±çš„mapã€‚

ç¼–è¯‘äº†ä¸ªè½¯ä»¶çœ‹äº†çœ‹compute006çš„numaæ¶æ„ï¼š

![server](/Users/ylf9811/Downloads/server.png)

## 0922

æŠŠpostionæ¢ä¸€ä¸‹

## 0923

æ²¡æ¢å®Œï¼Œæµ‹ä¸€ä¸‹no outï¼Œin fqï¼Œonly socket0

|           | getmap | producer/comsumer      | total |      |
| --------- | ------ | ---------------------- | ----- | ---- |
| thread 32 | 30     | 187/192-30=157/162     | 192   |      |
| thread 16 | 27     | 275/282-27=248/255     | 282   |      |
| thread 8  | 26     | 490/503-26=464/477     | 503   |      |
| thread 4  | 26     | 942/966-26=916/940     | 966   |      |
| thread 2  | 27     | 1841/1889-27=1814/1862 | 1889  |      |
| thread 1  | 27     | 3648/3742-27=3621/3715 | 3742  |      |



|           | getmap | producer/comsumer      | total |      |
| --------- | ------ | ---------------------- | ----- | ---- |
| thread 32 | 27     | 196/201-27=169/174     | 201   |      |
| thread 16 | 27     | 313/321-27=286/294     | 321   |      |
| thread 8  | 27     | 567/582-27=540/555     | 582   |      |
| thread 4  | 27     | 1092/1120-27=1065/1093 | 1120  |      |
| thread 2  | 31     | 2384/2449-31=2353/2418 | 2449  |      |
| thread 1  |        |                        |       |      |



çƒ¦å“¦ï¼Œè¿™è¿è¡Œæ€ä¹ˆå¿½å¿«å¿½æ…¢çš„ã€‚

pac

|                                     | get map | producer | consumer | total | time |
| ----------------------------------- | ------- | -------- | -------- | ----- | ---- |
| ./yrun.sh 64                        | 27      | 144      | 149      | 177   | 3m8  |
|                                     | 27      | 148      | 153      | 180   | 3m9  |
|                                     | 26      | 144      | 150      | 178   | 3m6  |
|                                     | 27      | 144      | 148      | 176   | 3m4  |
| ./yrun.sh 64 remove Positon         | 28      | 140      | 145      | 175   | 3m4  |
|                                     | 27      | 151      | 156      | 184   | 3m10 |
|                                     | 27      | 141      | 145      | 173   | 3m0  |
|                                     | 29      | 152      | 157      | 187   | 3m16 |
|                                     |         |          |          |       |      |
| ./yrun.sh 32                        | 26      | 171      | 177      | 203   | 3m28 |
|                                     | 27      | 169      | 174      | 201   | 3m29 |
|                                     | 27      | 171      | 176      | 204   | 3m32 |
|                                     | 26      | 173      | 178      | 207   | 3m29 |
|                                     |         |          |          |       |      |
| ./yrun.sh 32 remove Positon         | 21      | 152      | 157      | 178   |      |
|                                     | 21      | 153      | 158      | 180   |      |
|                                     | 21      | 150      | 155      | 176   |      |
|                                     | 21      | 151      | 155      | 177   |      |
|                                     | 21      | 153      | 158      | 179   |      |
|                                     | 21      | 143      | 148      | 169   |      |
|                                     |         |          |          |       |      |
| ./yrun.sh 32 remove Positon socket0 | 22      | 144      | 149      | 171   |      |
|                                     | 22      | 143      | 148      | 170   |      |
|                                     | 21      | 144      | 160      | 182   |      |
|                                     | 22      | 144      | 148      | 170   |      |
|                                     | 21      | 144      | 148      | 169   |      |
|                                     | 21      | 144      | 148      | 170   |      |
|                                     |         |          |          |       |      |
| ./yrun.sh 16                        | 26      | 293      | 301      | 329   | 5m30 |
|                                     | 28      | 287      | 295      | 327   | 5m28 |
|                                     | 28      | 288      | 296      | 324   | 5m27 |
|                                     | 26      | 288      | 296      | 323   | 5m28 |
|                                     |         |          |          |       |      |
| ./yrun.sh 16 remove Positon         |         |          |          |       |      |
|                                     |         |          |          |       |      |
|                                     |         |          |          |       |      |
|                                     |         |          |          |       |      |
|                                     |         |          |          |       |      |
| /yrun.sh 16 remove Positon socket0  | 21      | 223      | 229      | 251   |      |
|                                     | 21      | 223      | 230      | 252   |      |
|                                     | 21      | 223      | 229      | 251   |      |
|                                     | 22      | 223      | 229      | 251   |      |
|                                     | 21      | 223      | 229      | 250   |      |
|                                     |         |          |          |       |      |
| ./yrun.sh 8 remove Positon          |         |          |          |       |      |
|                                     |         |          |          |       |      |
|                                     |         |          |          |       |      |
|                                     |         |          |          |       |      |
|                                     |         |          |          |       |      |
| ./yrun.sh 8 remove Positon socket0  | 22      | 395      | 406      | 428   |      |
|                                     | 21      | 394      | 405      | 427   |      |
|                                     | 21      | 394      | 405      | 426   |      |
|                                     | 22      | 394      | 405      | 427   |      |
|                                     | 21      | 394      | 404      | 427   |      |
|                                     |         |          |          |       |      |
| ./yrun.sh 4 remove Positon          |         |          |          |       |      |
|                                     |         |          |          |       |      |
|                                     |         |          |          |       |      |
|                                     |         |          |          |       |      |
|                                     |         |          |          |       |      |
| ./yrun.sh 4 remove Positon socket0  | 21      | 748      | 768      | 790   |      |
|                                     | 21      | 752      | 772      | 794   |      |
|                                     | 21      | 747      | 767      | 789   |      |
|                                     | 21      | 750      | 770      | 792   |      |
|                                     | 21      | 751      | 770      | 792   |      |
|                                     |         |          |          |       |      |
| ./yrun.sh 2 remove Positon          |         |          |          |       |      |
|                                     |         |          |          |       |      |
|                                     |         |          |          |       |      |
|                                     |         |          |          |       |      |
|                                     |         |          |          |       |      |
| ./yrun.sh 2 remove Positon socket0  | 21      | 1463     | 1502     | 1523  |      |
|                                     | 22      | 1466     | 1504     | 1526  |      |
|                                     |         |          |          |       |      |

fat

|              | get map | producer | consumer | total | time  |
| ------------ | ------- | -------- | -------- | ----- | ----- |
| ./yrun.sh 40 | 40      | 174      | 180      | 220   | 3m40s |
|              | 34      | 169      | 175      | 210   | 3m31  |
|              | 35      | 169      | 174      | 209   | 3m29  |
|              | 33      | 170      | 176      | 209   | 3m30  |
|              |         |          |          | 210   |       |
|              |         |          |          | 214   |       |
|              |         |          |          |       |       |
| ./yrun.sh 20 | 34      | 317      | 327      | 363   | 6m2   |
|              | 34      | 314      | 323      | 357   | 5m58  |
|              | 36      | 319      | 329      | 366   | 6m6   |
|              | 35      | 322      | 331      | 367   | 6m7   |
|              | 34      | 298      | 307      | 341   | 5m42  |
|              | 33      | 306      | 315      | 349   | 5m49  |
|              |         |          |          | 352   |       |
| ./yrun.sh 10 |         |          |          |       |       |
|              |         |          |          |       |       |
|              |         |          |          |       |       |
|              |         |          |          |       |       |
|              |         |          |          |       |       |

```
rm -rf combine_read.fq && sleep 10 && time ../ST_BarcodeMap-0.0.1 --in DP8400016231TR_D1.barcodeToPos.h5 --in1 p1.fq --in2 p2.fq --out combine_read.fq --mismatch 2 --thread 32
```

## 0924 0925

ä¸€ç›´åœ¨åšæµ‹è¯•

å‘ç°äº†æƒŠå¤©å¤§ç§˜å¯†ï¼Œ006å’Œ003è¿è¡Œçš„ä¸ä¸€æ ·å¿«ï¼Œ003è¦å¿«ä¸€äº›ã€‚

|                                     | get map | producer | consumer | total | time         |
| ----------------------------------- | ------- | -------- | -------- | ----- | ------------ |
| ./yrun.sh 64 remove Positon         | 21      | 145      | 150      | 171   |              |
|                                     | 22      | 128      | 133      | 155   |              |
|                                     | 21      | 142      | 147      | 169   |              |
|                                     |         |          |          |       |              |
| ./yrun.sh 32 remove Positon         | 21      | 152      | 157      | 178   |              |
|                                     | 21      | 153      | 158      | 180   |              |
|                                     | 21      | 150      | 155      | 176   |              |
|                                     | 21      | 151      | 155      | 177   |              |
|                                     | 21      | 153      | 158      | 179   |              |
|                                     | 21      | 158      | 163      | 184   |              |
|                                     | 22      | 155      | 159      | 182   |              |
|                                     | 21      | 157      | 162      | 184   |              |
|                                     | 21      | 151      | 156      | 177   |              |
|                                     | 21      | 152      | 165      | 187   | 180*1.5=270  |
|                                     |         |          |          |       |              |
|                                     |         |          |          |       |              |
| ./yrun.sh 32 remove Positon socket0 | 22      | 144      | 149      | 171   |              |
|                                     | 22      | 143      | 148      | 170   |              |
|                                     | 21      | 144      | 160      | 182   |              |
|                                     | 22      | 144      | 148      | 170   |              |
|                                     | 21      | 144      | 148      | 169   |              |
|                                     | 21      | 144      | 148      | 170   |              |
|                                     | 21      | 143      | 148      | 169   |              |
|                                     | 21      | 144      | 148      | 171   |              |
|                                     | 21      | 143      | 148      | 170   |              |
|                                     | 21      | 144      | 148      | 178   |              |
|                                     | 21      | 144      | 148      | 170   |              |
|                                     | 21      | 143      | 148      | 170   | 170*1.47=250 |
|                                     |         |          |          |       |              |
| ./yrun.sh 16 remove Positon         | 22      | 242      | 249      | 271   |              |
|                                     | 21      | 241      | 248      | 270   |              |
|                                     | 21      | 243      | 250      | 271   |              |
|                                     | 21      | 242      | 249      | 271   |              |
|                                     | 21      | 243      | 249      | 271   | 270*1.81=490 |
|                                     |         |          |          |       |              |
| /yrun.sh 16 remove Positon socket0  | 21      | 223      | 229      | 251   |              |
|                                     | 21      | 223      | 230      | 252   |              |
|                                     | 21      | 223      | 229      | 251   |              |
|                                     | 22      | 223      | 229      | 251   |              |
|                                     | 21      | 223      | 229      | 250   |              |
|                                     | 21      | 223      | 230      | 251   |              |
|                                     | 21      | 223      | 230      | 251   |              |
|                                     | 21      | 223      | 230      | 251   |              |
|                                     | 21      | 223      | 230      | 256   |              |
|                                     | 21      | 223      | 230      | 252   | 252*1.69=427 |
|                                     |         |          |          |       |              |
| ./yrun.sh 8 remove Positon          | 22      | 453      | 465      | 488   |              |
|                                     | 21      | 456      | 469      | 490   |              |
|                                     | 21      | 456      | 468      | 490   |              |
|                                     | 21      | 456      | 468      | 490   |              |
|                                     | 21      | 454      | 466      | 487   |              |
|                                     |         |          |          |       |              |
| ./yrun.sh 8 remove Positon socket0  | 22      | 395      | 406      | 428   |              |
|                                     | 21      | 394      | 405      | 427   |              |
|                                     | 21      | 394      | 405      | 426   |              |
|                                     | 22      | 394      | 405      | 427   |              |
|                                     | 21      | 394      | 404      | 427   |              |
|                                     | 21      | 394      | 405      | 427   |              |
|                                     | 21      | 394      | 405      | 427   |              |
|                                     | 21      | 395      | 405      | 427   |              |
|                                     | 21      | 394      | 405      | 426   |              |
|                                     | 21      | 394      | 405      | 426   |              |
|                                     |         |          |          |       |              |
|                                     |         |          |          |       |              |
|                                     |         |          |          |       |              |
| ./yrun.sh 4 remove Positon          | 21      | 884      | 907      | 929   |              |
|                                     | 21      | 886      | 910      | 932   |              |
|                                     | 21      | 889      | 913      | 935   |              |
|                                     | 21      | 884      | 908      | 930   |              |
|                                     | 21      | 886      | 910      | 932   |              |
|                                     |         |          |          |       |              |
| ./yrun.sh 4 remove Positon socket0  | 21      | 748      | 768      | 790   |              |
|                                     | 21      | 752      | 772      | 794   |              |
|                                     | 21      | 747      | 767      | 789   |              |
|                                     | 21      | 750      | 770      | 792   |              |
|                                     | 21      | 751      | 770      | 792   |              |
|                                     | 21      | 750      | 770      | 791   |              |
|                                     | 21      | 750      | 770      | 791   |              |
|                                     | 21      | 750      | 770      | 791   |              |
|                                     | 21      | 750      | 770      | 792   |              |
|                                     | 21      | 750      | 770      | 791   |              |
|                                     |         |          |          |       |              |
| ./yrun.sh 2 remove Positon          | 21      | 1758     | 1804     | 1825  |              |
|                                     | 21      | 1756     | 1802     | 1824  |              |
|                                     |         |          |          |       |              |
|                                     |         |          |          |       |              |
|                                     |         |          |          |       |              |
| ./yrun.sh 2 remove Positon socket0  | 21      | 1463     | 1502     | 1523  |              |
|                                     | 22      | 1466     | 1504     | 1526  |              |
|                                     | 21      | 1467     | 1505     | 1527  |              |
|                                     | 21      | 1459     | 1497     | 1518  |              |
|                                     |         |          |          |       |              |
| ./yrun.sh 1 remove Positon          | 21      | 3033     | 3109     | 3131  |              |
|                                     |         |          |          |       |              |
| ./yrun.sh 1 remove Positon socket0  | 21      | 2887     | 2962     | 2984  |              |
|                                     |         |          |          |       |              |

## 0926

update ğŸ‘†

ç»è¿‡ç®€å•çš„æµ‹è¯•ï¼ŒæŒ‡å®šå•ä¸ªnumaèŠ‚ç‚¹æ•ˆæœè¦å¥½ä¸€ç‚¹ï¼Œ003æ¯”006è¦å¥½ä¸€ç‚¹ï¼Œç”¨Positionè¿˜æ˜¯int32ï¼ŒåŒºåˆ«ä¸å¤§ï¼Œæš‚æ—¶éƒ½ç”¨int32çš„ç‰ˆæœ¬ã€‚

å¥½å•Šï¼Œç»è¿‡ç®€å•çš„æµ‹è¯•ï¼Œè™½ç„¶å¤§å¸ˆå…„è¯´çš„çº¿ç¨‹åŠ é€Ÿæ¯”æ²¡æœ‰çœ‹å‡ºä»€ä¹ˆçŒ«è…»æ¥ï¼Œä½†æ˜¯ç¡®å®å•ä¸ªnumaèŠ‚ç‚¹è¦å¥½ä¸€äº›ï¼Œç°åœ¨æä¸€ä¸ªç‰ˆæœ¬ï¼Œæ¯ä¸ªnumaèŠ‚ç‚¹æœ‰è‡ªå·±çš„mapå‰¯æœ¬ï¼Œè¿™æ ·å°±ä¸å­˜åœ¨è¿œç¨‹numaè®¿é—®çš„é—®é¢˜äº†ã€‚

ç®€å•è¯•è¯•ï¼Œå°±æ˜¯åŒæ—¶è·‘ä¸¤ä¸ªç¨‹åºï¼Œæ¯æ¬¡32ä¸ªçº¿ç¨‹ï¼Œè·‘åœ¨ä¸åŒçš„numaèŠ‚ç‚¹ä¸Šï¼›å…·ä½“çš„ï¼Œä¸¤ä¸ªç¨‹åºä¼ ä¸€ä¸ªå‚æ•°--socketIdï¼Œ0æˆ–è€…1ï¼Œç„¶åç”Ÿäº§è€…åªæŠŠå¯¹åº”çš„å—è¯»è¿›æ¥æ”¾åˆ°é˜Ÿåˆ—é‡Œé¢äº¤ç»™æ¶ˆè´¹è€…å¤„ç†ï¼Œå†™å°±æš‚æ—¶åˆ†åˆ«å†™ä¸¤ä¸ªæ–‡ä»¶ã€‚

|                                                | get map | producer                | consumer                      | total   | time |
| ---------------------------------------------- | ------- | ----------------------- | ----------------------------- | ------- | ---- |
| socket0 32 half data                           | 21      | 71                      | 75                            | 97      |      |
|                                                | 21      | 71                      | 75                            | 97      |      |
|                                                | 21      | 71                      | 75                            | 97      |      |
| socket1 32 half data                           | 21      | 70                      | 74                            | 96      |      |
|                                                |         |                         |                               |         |      |
|                                                |         |                         |                               |         |      |
| merge ğŸ‘†                                        | 21/21   | 71/71                   | 75/75                         | 97/96   |      |
|                                                |         |                         |                               |         |      |
|                                                |         |                         |                               |         |      |
| in gzï¼Œout gz thread 64-1-4                    | 22      | 136 93/99               | 138/147                       | 169     |      |
|                                                |         |                         |                               |         |      |
| in gzï¼Œout gz thread 32-1-4  socket0 half data | 21      | 87 62/67                | 87/87                         | 109     |      |
|                                                |         |                         |                               |         |      |
| in gzï¼Œout gz thread 32-1-4  socket1 half data | 21      | 87 62/67                | 87/87                         | 109     |      |
|                                                |         |                         |                               |         |      |
| mpirun -n 1, in fq, out fq, thread 64          | 22      | 147                     | 152                           | 183     |      |
|                                                | 22      | 137                     | 142                           | 164     |      |
|                                                | 21      | 139                     | 144                           | 171     |      |
| mpirun -n 2, in fq, out fq, thread 32          | 22/22   | 68/68                   | 72/72(write:72/87)            | 95/110  |      |
|                                                | 22/22   | 68/68                   | 72/72(write:72/73)            | 94/95   |      |
| mpirun -n 2, in gz, out gz, thread 32          | 22/22   | 79/79(pugz:79/79 83/83) | 82/83(write:82/83 pigz:84/84) | 107/107 |      |
|                                                |         |                         |                               | 107/107 |      |
|                                                |         |                         |                               | 109/109 |      |
|                                                |         |                         |                               |         |      |

## 0928

è¯•äº†è¯•å¿«é€Ÿmodï¼Œæ²¡ä»€ä¹ˆç”¨ï¼Œæ™šä¸Šå°è¯•åŠ å¸ƒéš†è¿‡æ»¤å™¨ã€‚

|                     | get map/bloom | producer | consumer | total |
| ------------------- | ------------- | -------- | -------- | ----- |
| thread 64ï¼Œno mpiï¼Œ | 26            | 143      | 148      | 175   |
|                     | 26            | 139      | 143      | 169   |
|                     | 25            | 142      | 146      | 173   |
| thread 64ï¼Œ4 hash   | 35            | 194      | 201      | 237   |
| thread 64ï¼Œ1 hash   | 30            |          |          | 193   |

```
1 hash
total_query_cnt:	156371927497
after_filter_query_cnt:	144998762505

4 hash
total_query_cnt:	156371927497
after_filter_query_cnt:	156099493240

total_query_cnt:	156377424777
after_filter_query_cnt:	2431340523
find_query_cnt:	145470356

new wang hash
total_query_cnt:	156377424777
after_filter_query_cnt:	917789027
find_query_cnt:	145470356

```

## 0930

å¥½å•Šï¼Œä»Šå¤©å¿…é¡»è¦å‡ºç‚¹æ´»äº†ï¼Œç°åœ¨çš„æƒ…å†µæ˜¯ç®€å•è¯•äº†bloomfilterï¼Œç¡®å®èƒ½æŠŠ99%çš„æŸ¥è¯¢çš„ç­›æ‰ï¼Œä½†æ˜¯ç”¨äº†ä¸‰ä¸ªhashå‡½æ•°ï¼Œå¹¶ä¸”æ˜¯stlçš„bitsetä½œä¸ºæ•°æ®ç»“æ„å¯èƒ½éƒ½ä¸å¤ªé«˜æ•ˆï¼Œå‡†å¤‡æ›¿æ¢æˆæ‰‹å†™è¯•è¯•ã€‚

æ­¤å¤–ï¼Œä¸ºäº†æ›´å¥½çš„è¯„ä»·æ¯ä¸ªç‰ˆæœ¬çš„æ€§èƒ½æŒ‡æ ‡ï¼Œéœ€è¦å¯¹å„ä¸ªæ¨¡å—è®¡æ—¶ï¼Œç›®å‰çš„ç­–ç•¥æ˜¯æŠŠåŸæ¥é€»è¾‘é‡Œé¢çš„breakéƒ½å¹²æ‰ï¼Œç„¶åé€šè¿‡æ³¨é‡Šbloomfilterçš„ä»£ç æ¥è¯„ä»·æ—¶é—´ã€‚

å¥½å•Šï¼Œç°åœ¨æŠŠmisoverlapéƒ¨åˆ†çš„breakæ³¨é‡Šï¼Œæµ‹æµ‹æ—¶é—´å’ŒæŸ¥è¯¢æ¬¡æ•°ï¼š

```
no misoverlap break
total_query_cnt:        157473409122
after_filter_query_cnt: 1010068985
find_query_cnt: 233394250


```

è¿™æ ·æµ‹æ²¡å•¥ç”¨å•Šæ„Ÿè§‰ï¼Œä¸»è¦è¿˜æ˜¯æµ‹bfå å¤šå°‘æ—¶é—´ï¼Œæ”¹æ”¹ç­–ç•¥ï¼Œä¸€ä¸ªç‰ˆæœ¬ä¸åšbfï¼Œå¦ä¸€ä¸ªåšbfä½†æ˜¯ä¸ç”¨ä»–çš„ç»“æœã€‚

```
åšbfï¼š
42+197


ä¸åšbfï¼š
41+78

```



å¥½å•Šï¼Œç°åœ¨æ‰‹å†™ä¸€ä¸ªbloomfilterï¼Œç”¨uint64*æ¥ä½œä¸ºæ•°æ®ç»“æ„å­˜å‚¨ï¼Œå› ä¸ºå¾ˆå¤šhashå‡½æ•°éƒ½æ˜¯uint64        -> uint32ä¹‹ç±»çš„ï¼Œæ‰€ä»¥å­˜å‚¨çš„è¯bitæ•°å¤§çº¦æ˜¯1<<32ï¼Œä¹Ÿå°±æ˜¯1<<26è¿™ä¹ˆå¤§çš„uint64æ•°ç»„ï¼Œç„¶åæŸ¥è¯¢keyçš„æ—¶å€™è¦å¯¹åº”è½¬åŒ–ä¸ºã€‚ã€‚ã€‚

è¯•è¿‡äº†æ²¡å•¥ç”¨ã€‚

ç¡®å®èƒ½è¿‡æ»¤å¾ˆå¤šå¾ˆå¤šï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å¿«ï¼Œç”šè‡³æ…¢äº†10sï¼ˆ110--120ï¼‰

ç„¶åè¯•äº†è¯•æŠŠåŸæ¥çš„hashmapæ¢ä¸€ç§hashæ–¹å¼ï¼Œæ²¡å•¥ç”¨ï¼›è¯•äº†è¯•ç›´æ¥æŠŠhashæ•°ç»„å¼€å¤§4å€ï¼Œæ²¡å•¥ç”¨ã€‚

ç„¶åè¯•è¯•äºŒçº§ç´¢å¼•ã€å†…å­˜å°ä¸€ç‚¹çš„bfã€æŒ‘0ï¼Œ3ï¼Œ6ï¼Œ9ã€‚ã€‚ã€‚ä½åšç­›é€‰ã€

## 1003

01 02æ”¾å‡æ‘¸é±¼ã€‚

å‚æ­»ç—…ä¸­æƒŠåèµ·ï¼Œæ²¡æœ‰ç”¨æœ€æ–°çš„rabbitioï¼Œç”¨çš„æ˜¯rabbitqcä¸­çš„ï¼Œæœç„¶è‡ªå·±æŒ–çš„å‘ã€‚ã€‚ã€‚ã€‚

|                  | getmap | tot  | tot-getmap |
| ---------------- | ------ | ---- | ---------- |
| no processï¼Œ32*2 | 28     | 45   | 17         |
| no processï¼Œ64*1 | 28     | 61   | 33         |
| no processï¼Œ32*1 | 28     | 67   | 39         |
| ReRabbitQCï¼Œ48   | /      |      | 31         |
| RabbitQCï¼Œ48     |        |      | 31         |
| no processï¼Œ32*2 | 21     | 64   | 42         |

å˜¶ï¼Œæµ‹äº†æµ‹æ„Ÿè§‰å¤šçš„æ‹·è´ä¹Ÿæ²¡å•¥å½±å“å•Šã€‚å…ˆå†™å†™mpiåˆå¹¶è¾“å‡ºçš„ç‰ˆæœ¬å§ã€‚

## 1004

ğŸ‘†è¯´çš„ç‰ˆæœ¬ï¼Œæ”¹ä¹‹å‰æ—¶é—´å¤§çº¦24/28-111ã€25/28-109

æ”¹ä¹‹åsizeä¸å¤ªå¯¹emmmï¼Œæ—¶é—´å¤§çº¦25/28-116ã€25/28-118ã€24/27-118

æ·¦ï¼Œä»–sizeåˆå¯¹äº†ï¼Ÿï¼Ÿä¸Šåˆä¸Šè¯¾çš„æ—¶å€™ç—´å‘†äº†ï¼Ÿè¿˜æ˜¯é”™è¯¯æµ®ç°ä¸å‡ºæ¥äº†ï¼Ÿ

//TODO//TODO//TODO//TODO//TODO

ç”¨rabbitqcçœ‹ä¸€çœ‹è¾“å‡ºçš„ç»“æœï¼Œ

STDï¼š<img src="/Users/ylf9811/Library/Application Support/typora-user-images/image-20211004190937957.png" alt="image-20211004190937957" style="zoom:50%;" />

nowï¼š<img src="/Users/ylf9811/Library/Application Support/typora-user-images/image-20211004191001061.png" alt="image-20211004191001061" style="zoom:50%;" />

å¥½åƒçœŸçš„å¤ç°ä¸å‡ºæ¥äº†ã€‚ã€‚ã€‚ã€‚ã€‚

æš‚æ—¶å…ˆæŠŠé‡ç‚¹æ”¾åœ¨bfä¸Šå§ã€‚

ä¸€ä¸ªnumaèŠ‚ç‚¹ï¼š28-177ã€28-179ã€

in and out in shmã€one numa nodeï¼š28-170

è€ç”˜ç»™çš„é“¾æ¥é‡Œæœ‰å¥½å‡ ä¸ªmapï¼Œç®€å•å†™ä¸ªæµ‹è¯•æ€§èƒ½çš„ç©æ„ï¼š

```

#include <iostream>
#include <sparsehash/dense_hash_map>
#include <cstring>
#include <algorithm>
#include <sys/time.h>
#include <vector>
#include <random>
#include <unordered_map>

#define mm long long
//#define mm int

using google::dense_hash_map;      // namespace where class lives by default
using std::cout;
using std::endl;
using std::tr1::hash;  // or __gnu_cxx::hash, or maybe tr1::hash, depending on your OS
static const int mod = 1073807359;


double MainGetTime() {
    struct timeval tv;
    gettimeofday(&tv, NULL);
    return (double) tv.tv_sec + (double) tv.tv_usec / 1000000;
}

typedef struct node {
    int pre;
    mm v;
    int pos;
} node;


int main() {
    double t0 = MainGetTime();


    std::random_device rd;
    std::mt19937_64 gen(rd());

    std::uniform_int_distribution<mm> dis;


    std::vector<mm> G;
    std::vector<mm> P;
    int id;
    int cnt;
    int M = 2e8;
    int N = 1e9;

    for (int i = 0; i < M; i++) {
        G.push_back(dis(gen));
    }
    for (int i = 0; i < N; i++) {
        P.push_back(dis(gen));
    }
    printf("init cost %lf\n", MainGetTime() - t0);


    t0 = MainGetTime();
    dense_hash_map<mm, int> mps;

    mps.set_empty_key(NULL);
    id = 0;
    for (auto it:G) {
        id++;
        mps[it] = id;
    }
    printf("dense_hash_map insert cost %lf\n", MainGetTime() - t0);

    t0 = MainGetTime();
    cnt = 0;
    for (auto it:P) {
        if (mps.count(it))cnt++;
    }
    printf("dense_hash_map find %d\n", cnt);
    printf("dense_hash_map find cost %lf\n", MainGetTime() - t0);


    t0 = MainGetTime();
    id = 0;

    int *hashHead = new int[mod + 10];
    for (int i = 0; i < mod; i++)hashHead[i] = -1;
    node *hashMap = new node[M + 10];
    int hashNum = 0;
    for (auto it:G) {
        id++;
        int key = it % mod;
        int ok = 0;
        for (int i = hashHead[key]; i != -1; i = hashMap[i].pre)
            if (hashMap[i].v == it) {
                hashMap[i].pos = id;
                ok = 1;
                break;
            }
        if (ok == 0) {
            hashMap[hashNum].v = it;
            hashMap[hashNum].pos = id;
            hashMap[hashNum].pre = hashHead[key];
            hashHead[key] = hashNum;
            hashNum++;
        }
    }
    printf("gogo insert cost %lf\n", MainGetTime() - t0);
    t0 = MainGetTime();
    cnt = 0;
    for (auto it:P) {
        int ok = 0;
        int pos = -1;
        int key = it % mod;
        for (int i = hashHead[key]; i != -1; i = hashMap[i].pre) {
            if (hashMap[i].v == it) {
                pos = hashMap[i].pos;
                ok = 1;
                break;
            }
        }
        if (ok)cnt++;
    }
    printf("gogo find %d\n", cnt);
    printf("gogo find cost %lf\n", MainGetTime() - t0);

    t0 = MainGetTime();
    std::unordered_map<mm, int> mp2s;
    id = 0;
    for (auto it:G) {
        id++;
        mp2s[it] = id;
    }
    printf("stl unordered_map insert cost %lf\n", MainGetTime() - t0);


    t0 = MainGetTime();
    cnt = 0;
    for (auto it:P) {
        if (mp2s.count(it))cnt++;
    }
    printf("stl unordered_map find %d\n", cnt);
    printf("stl unordered_map find cost %lf\n", MainGetTime() - t0);

}

M=2e8 N=1e9 thread=1

[PAC20217111@compute003 ylf]$ ./hashTest
init cost 27.841362
dense_hash_map insert cost 18.319946
dense_hash_map find 166
dense_hash_map find cost 30.111485
gogo insert cost 7.738144
gogo find 166
gogo find cost 25.507501
stl unordered_map insert cost 70.406113
stl unordered_map find 166
stl unordered_map find cost 55.771334

ğŸ‘† use find not count
[PAC20217111@compute003 ylf]$ ./hashTest
init cost 28.364878
dense_hash_map insert cost 15.537160
dense_hash_map find 174
dense_hash_map find cost 37.527437
sparse_hash_map insert cost 116.459556
sparse_hash_map find 174
sparse_hash_map find cost 175.995829
gogo insert cost 7.135087
gogo find 174
gogo find cost 24.261454
stl unordered_map insert cost 73.188713
stl unordered_map find 174
stl unordered_map find cost 61.126728


M=6e7 N=1e9 thread=1
[PAC20217111@compute003 ylf]$ ./hashTest
init cost 22.414524
dense_hash_map insert cost 4.985887
dense_hash_map find 55
dense_hash_map find cost 34.944564
sparse_hash_map insert cost 34.306814
sparse_hash_map find 55
sparse_hash_map find cost 53.169762
gogo insert cost 2.976034
gogo find 55
gogo find cost 21.728029
stl unordered_map insert cost 18.886106
stl unordered_map find 55
stl unordered_map find cost 63.939711

[PAC20217111@compute003 ylf]$ time ./hashTest
init cost 24.635170
google::dense_hash_map insert cost 4.901080
google::dense_hash_map find 63
google::dense_hash_map find cost 35.008083
google::sparse_hash_map insert cost 33.590294
google::sparse_hash_map find 63
google::sparse_hash_map find cost 51.789670
spp::sparse_hash_map insert cost 17.595097
spp::sparse_hash_map find 63
spp::sparse_hash_map find cost 43.207952
gogo insert cost 2.930788
gogo find 63
gogo find cost 21.738789
stl unordered_map insert cost 20.002673
stl unordered_map find 63
stl unordered_map find cost 64.700771


M=2e8 N=1e9 thread=32

[PAC20217111@compute003 ylf]$ ./hashTest
init cost 26.854261
dense_hash_map insert cost 18.031583
dense_hash_map find 182
dense_hash_map find cost 2.938416
gogo insert cost 7.980589
gogo find 182
gogo find cost 2.200198
stl unordered_map insert cost 69.550551
stl unordered_map find 182
stl unordered_map find cost 3.741968


M=2e8 N=1e10 thread=32
[PAC20217111@compute003 ylf]$ ./hashTest
init cost 319.879172
dense_hash_map insert cost 23.582168
dense_hash_map find 1639
dense_hash_map find cost 18.351356
gogo insert cost 7.843452
gogo find 1639
gogo find cost 14.136651
stl unordered_map insert cost 82.213892
stl unordered_map find 1639
stl unordered_map find cost 29.233407


M=2e8 N=1e9 thread=32
[PAC20217111@compute003 ylf]$ ./hashTest
init cost 7.282487
dense_hash_map insert cost 11.859019
dense_hash_map find 95475949
dense_hash_map find cost 2.299639
sparse_hash_map insert cost 74.191624
sparse_hash_map find 95475949
sparse_hash_map find cost 6.081009
gogo insert cost 4.767718
gogo find 95475949
gogo find cost 1.383346
stl unordered_map insert cost 68.503956
stl unordered_map find 95475949
stl unordered_map find cost 3.647662

```

## 1005

å˜¶ï¼Œæ²¡å•¥ç”¨å“ï¼Œæ„Ÿè§‰æ‰‹å†™çš„hashmapåº”è¯¥å°±æ˜¯æœ€å¿«çš„äº†ï¼Œè¿˜æ˜¯å›åˆ°bfä¸Šå¼„å¼„ã€‚

æ‰¾åˆ°ä¹‹å‰ä¸¤ä¸ªè¿›ç¨‹mergeè¾“å‡ºçš„é—®é¢˜äº†ï¼ŒåŸæ¥æ£€æµ‹æ˜¯å¦ç»“æŸæ˜¯p0çš„æ¶ˆè´¹è€…ç»“æŸäº†å°±setï¼Œå¯èƒ½p0çš„cä»¬ç»“æŸäº†ï¼Œæ°å¥½é˜Ÿåˆ—ç©ºäº†ï¼ˆp1çš„mergeThreadæ²¡æ¥åŠå¡æ•°æ®ï¼‰ï¼Œç„¶åæ²¡è¾“å‡ºå…¨ï¼Œç°åœ¨å¤šåŠ äº†ä¸ªflagå°±å¥½äº†ã€‚

å›é€€å›æ¯”è¾ƒç®€æ´çš„commit 9a40937c573b6dc459d8e00d5df7930ba7d1815bã€‚

|                           | getmap      | oo                      | tot  |                                                              |
| ------------------------- | ----------- | ----------------------- | ---- | ------------------------------------------------------------ |
| ğŸ‘†æäº¤ thread64            | 28          | 152                     | 180  |                                                              |
| ğŸ‘†gcc8                     | 24          | 148                     | 173  |                                                              |
|                           | 29          | 135                     | 164  |                                                              |
|                           | 23          | 132                     | 155  |                                                              |
| ğŸ‘†gcc4                     | 23          | 152                     | 175  |                                                              |
|                           | 26          |                         | 187  |                                                              |
| ğŸ‘†icpc                     | 29          | 144                     | 173  |                                                              |
|                           | 24          | 140                     | 164  |                                                              |
|                           |             |                         |      |                                                              |
| old + bf*3 thread 64      | 46          | 146                     | 192  | total_query_cnt:	156377424777<br/>after_filter_query_cnt:	1079936634 |
|                           | 41          | 153                     | 194  | total_query_cnt:	156377424777<br/>after_filter_query_cnt:	1079936634 |
| old no bf thread 64       | 42          | 150                     | 193  | total_query_cnt:	156377424777<br/>after_filter_query_cnt:	0 |
|                           | 42          | 154                     | 197  | total_query_cnt:	156377424777<br/>after_filter_query_cnt:	0 |
|                           | 27ï¼ˆno bfï¼‰ | 159                     | 187  | total_query_cnt:	156377424777<br/>after_filter_query_cnt:	0 |
|                           |             |                         |      |                                                              |
|                           |             |                         |      |                                                              |
| old no bf thread 32*2     | 26-28       | //77-//81               | 108  | total_query_cnt:	156377424777<br/>after_filter_query_cnt:	0 |
|                           | 26-27       | //77-//100              | 120  | total_query_cnt:	156377424777<br/>after_filter_query_cnt:	0 |
| old + bfï¼šh1 thread 64    | 34          | 147                     | 181  | total_query_cnt:	156377424777<br/>after_filter_query_cnt:	10064669874 |
|                           | 33          | 145                     | 179  | total_query_cnt:	156377424777<br/>after_filter_query_cnt:	10064669874 |
|                           | 34          | 144                     | 179  | total_query_cnt:	156377424777<br/>after_filter_query_cnt:	10064669874 |
| old + bfï¼šh0 thread 64    | 37          | 148                     | 186  | total_query_cnt:	156377424777<br/>after_filter_query_cnt:	9415169025 |
|                           | 34          | 152                     | 186  | total_query_cnt:	156377424777<br/>after_filter_query_cnt:	9415169025 |
|                           |             |                         |      |                                                              |
| old + bfï¼šh3 thread 64    | 33          | 130                     | 163  | total_query_cnt:	156377424777<br/>after_filter_query_cnt:	9639439838 |
|                           | 33          | 145                     | 178  | total_query_cnt:	156377424777<br/>after_filter_query_cnt:	9639439838 |
|                           | 33          | 141                     | 174  | -                                                            |
|                           | 33          | 133                     | 166  | -                                                            |
|                           | 30          | 132                     | 162  | -                                                            |
| ğŸ‘† thread32 * 2            | 32-33       | 48/51/51-48/51/76ï¼Ÿï¼Ÿï¼Ÿ | 110  | total_query_cnt:	156377424777<br/>after_filter_query_cnt:	9639439838 |
|                           |             | -------78               | 111  | -                                                            |
|                           |             | ---------54             | 84   |                                                              |
|                           |             | ---------56             | 88   |                                                              |
|                           | 31-33       | -------54               | 85   |                                                              |
| ğŸ‘†mod -> dxh               |             |                         |      |                                                              |
| 32*2                      | 30-32       | --------90-92           | 123  | total_query_cnt:	156377424777<br/>after_filter_query_cnt:	33984170386 |
|                           |             |                         |      |                                                              |
|                           |             |                         |      |                                                              |
|                           |             |                         |      |                                                              |
| ğŸ‘†inline by hand           |             |                         |      |                                                              |
|                           |             |                         |      |                                                              |
| ğŸ‘† shm                     | 32-32       | 47/49/49-48/51/51       | 83   | total_query_cnt:	156377424777<br/>after_filter_query_cnt:	9639439838 |
|                           |             | ---------51             | 82   |                                                              |
| old + bfï¼šh1 thread 32 *2 | 31-34       | 62/65/65-59/63/63       | 97   | total_query_cnt:	156377424777<br/>after_filter_query_cnt:	10064669874 |
|                           |             | -----69                 | 101  |                                                              |

æ†¨æ‰¹äº†å±äºæ˜¯ï¼Œåœ¨æµ‹ä¹‹å‰commitçš„æ—¶å€™çªç„¶å°±å‘ç°äº†ä¸€ç‚¹ç‚¹ä¹‹å‰çš„bugï¼š

<img src="/Users/ylf9811/Library/Application Support/typora-user-images/image-20211005234621491.png" alt="image-20211005234621491" style="zoom:50%;" />

æ”¹äº†ä¹‹åæœ€ç»ˆåªç”¨å‰32å32ä½xorçš„ç®€å•hashæ•ˆæœæœ€å¥½ï¼Œå¹¶ä¸”è·‘åœ¨ä¸¤ä¸ªnumaèŠ‚ç‚¹ä¸Šæ•ˆæœæ›´å¥½ï¼Œä¸è¿‡ä¼¼ä¹æ˜¯å¡åœ¨äº†å†™æ•°æ®ä¸Šï¼Œå¼„åˆ°shmå°±åŸºæœ¬ä¸Šæ˜¯30+50=80äº†ï¼ˆä¸è¿‡æµ‹å¾—éƒ½æ˜¯fqï¼Œgzåº”è¯¥ä¹Ÿå·®ä¸å¤šï¼‰ã€‚

## 1006

updateğŸ‘†

no bfå•èŠ‚ç‚¹æŸ¥è¯¢æœ€å¥½æ˜¯150sï¼ŒåŒèŠ‚ç‚¹æ˜¯81sï¼Œä½¿ç”¨hash3æ„é€ bfçš„è¯ï¼Œå•èŠ‚ç‚¹æŸ¥è¯¢æœ€å¥½æ˜¯130sï¼ŒåŒèŠ‚ç‚¹æ˜¯58sï¼Œæ¯”è¾ƒå¥‡æ€ªçš„æ˜¯ä¸ºå•¥åŠ é€Ÿäº†ä¸¤å€è¿˜å¤šï¼Ÿï¼Ÿï¼Ÿä½†ç­”æ¡ˆç¡®å®æ˜¯å¯¹çš„ã€‚

æœ€å¿«çš„ç‰ˆæœ¬å»fatèŠ‚ç‚¹æµ‹äº†ä¸€ä¸‹ï¼Œå‘ç°å•èŠ‚ç‚¹å’ŒåŒèŠ‚ç‚¹æ—¶é—´å‡ ä¹ä¸€æ ·ï¼Œéš¾é“æ˜¯fatä¸Šçš„å†…å­˜æ¯”è¾ƒğŸ‚æ²¡æœ‰è¿œç¨‹numaè®¿å­˜çš„é—®é¢˜ï¼Ÿå¥½åƒä¹Ÿæ˜¯æœ‰ç‚¹ç”¨ï¼Œæ•ˆæœä¸å¦‚pacæœºå™¨ä¸Šé‚£ä¹ˆçŒ›ã€‚

ç»è¿‡åœ¨fatèŠ‚ç‚¹ä¸Šè·‘vtuneçš„ä¸€äº›è§‚å¯ŸğŸ‘‡

thread 64 * 1ï¼Œadd bfï¼š

![image-20211006171010632](/Users/ylf9811/Library/Application Support/typora-user-images/image-20211006171010632.png)

![image-20211006171033940](/Users/ylf9811/Library/Application Support/typora-user-images/image-20211006171033940.png)

![image-20211006171039232](/Users/ylf9811/Library/Application Support/typora-user-images/image-20211006171039232.png)

å¯ä»¥çœ‹åˆ°ç»å¤§éƒ¨åˆ†æ—¶é—´è¿˜æ˜¯æ¥è‡ªhashMapçš„éšæœºè®¿å­˜ï¼Œbfèƒ½è¿‡æ»¤æ‰90%çš„è¯¢é—®ï¼Œå¹¶ä¸”ä¸å¤ªå æ—¶é—´ã€‚

thread64 * 1ï¼Œno bfï¼š

![image-20211006171419243](/Users/ylf9811/Library/Application Support/typora-user-images/image-20211006171419243.png)

![image-20211006171424154](/Users/ylf9811/Library/Application Support/typora-user-images/image-20211006171424154.png)

ç„¶åzzè¯´å¾ˆå¤šbfæ²¡æœ‰è¿‡æ»¤æ‰çš„queryï¼ˆ9e8/156e8ï¼‰é‡Œé¢åªæœ‰3e8èƒ½è¿›forå¾ªç¯ï¼ˆhash[key]=-1ï¼‰ï¼ˆå®é™…ä¸Šèƒ½æŸ¥åˆ°çš„åªæœ‰1e8ï¼‰ï¼Œå°±æŠŠè¿™ä¸ªå•ç‹¬æ‰“å‡ºæ¥ï¼š

![image-20211006172054447](/Users/ylf9811/Library/Application Support/typora-user-images/image-20211006172054447.png)

![image-20211006172204133](/Users/ylf9811/Library/Application Support/typora-user-images/image-20211006172204133.png)

![image-20211006172212027](/Users/ylf9811/Library/Application Support/typora-user-images/image-20211006172212027.png)

## 1007

å±•å­å“¥ç»ˆäºå®‰å¥½äº†gcc8ï¼Œè¯•äº†è¯•ï¼Œåœ¨å¾ˆä¹…ä¹‹å‰çš„çº¯hashMapçš„commitä¸‹æ¯”gcc4è¦å¿«ä¸€ç‚¹ï¼Œæ¯”icpcä¹Ÿè¦å¿«ä¸€ä¸¢ä¸¢ï¼Œå‡ ä¹ä¸€æ ·ã€‚

ä»Šå¤©å®åœ¨æ˜¯å¿ä¸äº†äº†ï¼Œæ¯æ¬¡å·®1.5e11æ¬¡å¤ªæ…¢äº†ã€‚ã€‚ã€‚ã€‚å°è¯•æŠŠ20Gçš„fqæ–‡ä»¶æˆªå–æˆ2Gï¼ŒhashMapå¤§å°ä¸å˜ï¼Œè¿™æ ·åº”è¯¥å’ŒåŸæ¥çš„è®¡ç®—æ¨¡å‹å·®ä¸å¤šï¼Œç®€å•æ”¹ä¸€ä¸‹pacæœºå™¨ä¸Šçš„rabbitqcæ¥åšæˆªå–å§ã€‚

ç®—äº†ï¼Œå¤ªæ‡’äº†ï¼Œç›´æ¥ç”¨headå§ã€‚

sp1 sp2 2G

|                | getmap | write done | tot  |      |      |
| -------------- | ------ | ---------- | ---- | ---- | ---- |
| gcc8 64 thread | 27     | 18         | 46   |      |      |
|                | 26     | 18         | 45   |      |      |
| gcc4           | 26     | 21         | 48   |      |      |
|                | 26     | 22         | 49   |      |      |
| icpc           | 28     | 20         | 49   |      |      |
|                | 26     | 19         | 46   |      |      |
|                |        |            |      |      |      |
|                |        |            |      |      |      |

```
small data ANS
total_reads:	20000000
fixed_sequence_contianing_reads:	0	0.00%
pass_filter_reads:	20000000
mapped_reads:	14727394	73.64%
barcode_exactlyOverlap_reads:	11828527	59.14%
barcode_misOverlap_reads:	2898867	14.49%
barcode_withN_reads:	0	0.00%
Q10_bases_in_barcode:	99.24%
Q20_bases_in_barcode:	96.66%
Q30_bases_in_barcode:	90.35%
Q10_bases_in_umi:	98.08%
Q20_bases_in_umi:	93.15%
Q30_bases_in_umi:	85.09%
umi_filter_reads:	411457	2.06%
umi_with_N_reads:	10	0.00%
umi_with_polyA_reads:	481	0.00%
umi_with_low_quality_base_reads:	410966	2.05%


2263572480
```

å˜¶

gcc8æ„Ÿè§‰æ˜¯æœ‰ç‚¹å­ç”¨å¤„çš„ï¼Œè€Œä¸”æ™šä¸Šåœ¨fatä¸Šè¯•äº†æŠŠhashMapçš„hash1æ”¹æˆhash3ï¼Œæ²¡å•¥ç”¨ã€‚ä½†æ˜¯åœ¨pacæœºå™¨ä¸Šè·‘bfçš„ç‰ˆæœ¬çš„æ—¶å€™ï¼Œç¼–è¯‘å‡ºé—®é¢˜äº†ï¼Œæ˜¯å‘é‡åŒ–æŒ‡ä»¤é›†æœ‰å…³çš„ï¼Œä½†æ˜¯ä¼¼ä¹æ˜¯pugzé‡Œé¢çš„æ–‡ä»¶æŠ¥é”™çš„ï¼Œç°åœ¨å¹¶æ²¡æœ‰ç”¨ï¼Œè€Œä¸”ç”¨çš„æ˜¯mpiiccç¼–è¯‘çš„ï¼Œæ¢æˆgcc8æŒ‰ç†è¯´ä¸åº”è¯¥å’Œä¹‹å‰ä¸ä¸€æ ·ï¼Œç®€å•åŠ äº†includeä¹‹åæ¯”ä¹‹å‰çš„86å¿«ï¼Œç°åœ¨79ã€‚ã€‚ã€‚ã€‚æ˜å¤©æµ®ç°ä¸€ä¸‹è¿™ä¸ªé—®é¢˜ä»”ç»†çœ‹çœ‹

## 1008

|                                                              | getmap | writedone | total |
| ------------------------------------------------------------ | ------ | --------- | ----- |
| big data fqï¼Œthread 32 * 2ï¼Œhas bfï¼Œgcc4ï¼Œmpiicc             | 31-32  | 50-51     | 83    |
|                                                              |        |           | 83    |
|                                                              |        |           | 83    |
| remove include                                               |        |           | 82    |
| big data fqï¼Œthread 32 * 2ï¼Œhas bfï¼Œgcc8ï¼Œmpiicc             | 32-32  | 49-49     | 81    |
|                                                              | 32-32  | 48-48     | 81    |
|                                                              | 32-32  | 48-48     | 80    |
| remove include                                               | ce     | ce        | ce    |
|                                                              |        |           |       |
| big data fqï¼Œthread 32 * 2ï¼Œhas bfï¼Œgcc4ï¼Œmpigxx+mpigcc      | 31-32  | 50-51     | 83    |
|                                                              |        |           | 82    |
| big data fqï¼Œthread 32 * 2ï¼Œhas bfï¼Œgcc8ï¼Œmpigxx+mpigccï¼ˆæ—©ä¸Šï¼‰ | 30-31  | 47-47     | 78    |
| ï¼ˆä¸‹åˆï¼‰                                                     | 31-32  | 54-57     | 89    |
|                                                              |        |           | 93    |
|                                                              | 32-33  |           | 83    |
|                                                              |        |           | 93    |
| (æ™šä¸Š)                                                       | 31-31  | 46-46     | 77    |
|                                                              |        |           | 78    |
| big data fqï¼Œthread 32 * 2ï¼Œhas bfï¼Œgcc11ï¼Œmpigxx+mpigccï¼ˆæ™šä¸Šï¼‰ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ | 31-31  | 35-36     | 68    |
|                                                              |        |           | 67    |
|                                                              |        |           | 68    |
| big data fqï¼Œthread 32 * 2ï¼Œhas bfï¼Œgcc9ï¼Œmpigxx+mpigccï¼ˆæ™šä¸Šï¼‰ |        |           |       |
|                                                              |        |           |       |
| big data fqï¼Œthread 32 * 2ï¼Œhas bfï¼Œgcc7ï¼Œmpigxx+mpigccï¼ˆæ™šä¸Šï¼‰ | 31-31  | 48-48     | 79    |
|                                                              |        |           | 81    |
| big data fqï¼Œthread 32 * 2ï¼Œhas bfï¼Œgcc4ï¼Œmpiicpc+mpiicc     |        |           |       |
|                                                              |        |           |       |
| big data fqï¼Œthread 32 * 2ï¼Œhas bfï¼Œgcc8ï¼Œmpiicpc+mpiicc     |        |           |       |
|                                                              |        |           |       |
|                                                              |        |           |       |
| big data fqï¼Œthread 32 * 2ï¼Œhas bfï¼Œgcc4ï¼Œmpicc+mpic++       | 31-32  | 72-72     | 104   |
|                                                              | 32-32  | 60-61     | 93    |
|                                                              |        |           | 97    |
| big data fqï¼Œthread 32 * 2ï¼Œhas bfï¼Œgcc8ï¼Œmpicc+mpic++       | 31-32  | 59-60     | 92    |
|                                                              | 31-32  |           | 88    |
|                                                              |        |           | 87    |
|                                                              |        |           |       |

å¥½å•Šï¼Œåˆæµ®ç°äº†ä¸€ä¸‹æ˜¨å¤©å¾ˆå¥‡æ€ªçš„é”™è¯¯ï¼Œæœç„¶å¼€å¼€gcc8pugzå°±æ²¡æ³•è¿‡ç¼–è¯‘ï¼Œéœ€è¦åŠ ä¸Šå‘é‡åŒ–çš„å¤´æ–‡ä»¶ã€‚è€Œä¸”gcc8ä¼¼ä¹å¯èƒ½ä¹Ÿè®¸æ˜¯å¿«ä¸€ä¸¢ä¸¢ã€‚ä½†æ˜¯æ²¡é“ç†ï¼Œå› ä¸ºå¤´æ–‡ä»¶å½±å“çš„pugzç°åœ¨æ ¹æœ¬æ²¡ç”¨ï¼Œè€Œä¸”ç°åœ¨ç”¨çš„æ˜¯mpiiccï¼Œmpiicc --versionæ˜¾ç¤ºçš„æ˜¯iccçš„versionï¼Œmpiccæ‰æ˜¯gccçš„ï¼Œä½†æ˜¯ç”¨mpiccï¼ˆintelç›®å½•ä¸‹çš„ï¼‰ç›´æ¥ç¼–è¯‘ä¼šæŠ¥é”™ã€‚

ï¼ˆæ·¦ æœºå™¨åˆæ…¢èµ·æ¥äº†ï¼‰

å®‰å¥½äº†mpichï¼Œåœ¨æˆ‘çš„ç†è§£èŒƒå›´å†…è¯•äº†è¯•gcc4å’Œgcc8çš„åŒºåˆ«ï¼Œgcc8ç¨å¿«ä¸€ç‚¹ã€‚

åˆè¯•äº†è¯•gcc11ğŸ‘†çŒ›å•Šï¼Œå…·ä½“ä¸ºå•¥æ˜å¤©çœ‹çœ‹æ±‡ç¼–ã€‚

## 1009

//TODO

æ—©ä¸Šæ‰“æ°´çš„æ—¶å€™çªç„¶æƒ³åˆ°ï¼Œèƒ½ä¸èƒ½å¼€ä¸ªäºŒçº§çš„bfï¼ŒåŸæ¥32ä½å¤§å°ï¼Œç°åœ¨ä¸¤ä¸ª16ä½å¤§å°çš„ï¼Œåˆ¤æ–­ind=hash(barcode)æ˜¯ä¸æ˜¯å‡ºç°è¿‡ï¼ŒåŸæ¥æ˜¯bfInit[ind]==1ï¼Œç°åœ¨å¯ä»¥å†™æˆbfNow0[ind0]&&bfNow[ind1]ï¼Œind01åˆ†åˆ«æ˜¯indçš„é«˜16ä½å’Œä½16ä½ã€‚

å¥½å•Šï¼Œå…ˆåƒé¥­ã€‚rebootä¸€ä¸‹ã€‚

å¥½å•Šï¼Œç°åœ¨è¯»å†™å†…å­˜çš„è¯ï¼Œfqä¸¤ä¸ªnumaèŠ‚ç‚¹æŸ¥è¯¢å¤§çº¦36sï¼Œä¸€ä¸ªnumaèŠ‚ç‚¹æŸ¥è¯¢å¤§çº¦50sï¼ŒåŸºæœ¬ä¸Šæ²¡å•¥é—®é¢˜äº†ï¼Œå…·ä½“å•¥åŸå› å°±è®©zzå»çœ‹çœ‹å§ï¼Œç°åœ¨å…ˆå•ä¸ªnumaèŠ‚ç‚¹æŠŠgzæ‰“å¼€è¯•è¯•ã€‚

|                                | getmap | writer done | total | bf rate                                                      | work thread | pugz                                                         |
| ------------------------------ | ------ | ----------- | ----- | ------------------------------------------------------------ | ----------- | ------------------------------------------------------------ |
| 64*1ï¼Œfqï¼Œshm                  | 31     | 49          | 80    | total_query_cnt:	156371927497<br/>after_filter_query_cnt:	9634745468 | ï½64        |                                                              |
| 64*1ï¼Œinit gzï¼Œdisk            | 31     | 176-176/495 | 529   | -                                                            | ï½16        |                                                              |
| 64*1ï¼Œinit gz inï¼Œfq outï¼Œshm  | 33     | 174         | 208   |                                                              | ï½16        |                                                              |
| 64*1ï¼Œpugz8 gz inï¼Œfq outï¼Œshm | 41     | 103         | 144   |                                                              | ï½30        | gunzip and push data to memory cost 30.2385<br/>gunzip and push data to memory cost 32.4541 |
|                                | 44     | 103         | 148   |                                                              | ï½30        | gunzip and push data to memory cost 30.1984<br/>gunzip and push data to memory cost 32.4931 |
|                                |        |             |       |                                                              |             |                                                              |
| 32*2ï¼Œinit gz inï¼Œfq outï¼Œshm  | 31-31  | 172-172     | 204   |                                                              | ï½7+7       |                                                              |
| 32*2ï¼Œpugz1 gz inï¼Œfq outï¼Œshm | 33-36  | 75-78/      | 111   |                                                              | ï½16+16     | gunzip and push data to memory cost 57<br/>gunzip and push data to memory cost 57<br/>gunzip and push data to memory cost 60<br/>gunzip and push data to memory cost 61 |
|                                | 32-32  | 71-71       | 104   |                                                              | ï½16+16     | gunzip and push data to memory cost 56<br/>gunzip and push data to memory cost 56<br/>gunzip and push data to memory cost 60<br/>gunzip and push data to memory cost 60 |
| 32*2ï¼Œpugz2 gz inï¼Œfq outï¼Œshm | 34-36  | 77-78       | 113   |                                                              | ï½16+16     | gunzip and push data to memory cost 42<br/>gunzip and push data to memory cost 42<br/>gunzip and push data to memory cost 45<br/>gunzip and push data to memory cost 45 |
|                                | 34-34  | 74-74       | 109   |                                                              | ï½16+16     | gunzip and push data to memory cost 41<br/>gunzip and push data to memory cost 42<br/>gunzip and push data to memory cost 44<br/>gunzip and push data to memory cost 44 |
|                                | 34-34  | 74-74       | 109   |                                                              | ï½16+16     | gunzip and push data to memory cost 41<br/>gunzip and push data to memory cost 42<br/>gunzip and push data to memory cost 44<br/>gunzip and push data to memory cost 45<br/>gunzip and push data to memory cost 42<br/>gunzip and push data to memory cost 42<br/>gunzip and push data to memory cost 45<br/>gunzip and push data to memory cost 45 |
| 32*2ï¼Œpugz4 gz inï¼Œfq outï¼Œshm | 34-35  | 77-77       | 112   |                                                              | ï½15+15     | gunzip and push data to memory cost 30.443<br/>gunzip and push data to memory cost 30.5704<br/>gunzip and push data to memory cost 32.6724<br/>gunzip and push data to memory cost 32.9539 |
|                                | 34-34  | 75-76       | 110   |                                                              | ï½15+15     | gunzip and push data to memory cost 30.4799<br/>gunzip and push data to memory cost 30.5536<br/>gunzip and push data to memory cost 32.8386<br/>gunzip and push data to memory cost 32.8623 |
| 32*2ï¼Œpugz8 gz inï¼Œfq outï¼Œshm | 35-35  | 76-76       | 113   |                                                              | ï½15+15     | gunzip and push data to memory cost 26.0721<br/>gunzip and push data to memory cost 26.3924<br/>gunzip and push data to memory cost 27.9054<br/>gunzip and push data to memory cost 28.2095 |
|                                | 35-35  | 77-77       | 112   |                                                              |             | gunzip and push data to memory cost 26.0642<br/>gunzip and push data to memory cost 26.3153<br/>gunzip and push data to memory cost 27.8736<br/>gunzip and push data to memory cost 28.1623 |
|                                |        |             |       |                                                              |             |                                                              |
| 64*1ï¼Œpxgz gz 2+8ï¼Œdisk        | 34     |             |       |                                                              |             |                                                              |

æœ‰ç‚¹å­å¥‡æ€ªå“¦ï¼Œä¸ºå•¥è¿˜èƒ½è¾“å‡º8ä¸ªcostï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ

è€Œä¸”ï¼Œå¤šä¸ªpugzçº¿ç¨‹çš„è¯ï¼Œå°±ç®—ä»–å¿«åˆ°åœ¨æ„å»ºhashMapæœŸé—´å°±è§£å‹å®Œäº†ï¼Œåé¢queryçš„æ—¶å€™ä¹Ÿè¿˜æ˜¯å¿«ä¸èµ·æ¥ï¼Œåªèƒ½ç”¨èµ·15+15ä¸ªçº¿ç¨‹ï¼Œ

## 1010

|                                 | getmap | write done | total                |                                                              |
| ------------------------------- | ------ | ---------- | -------------------- | ------------------------------------------------------------ |
| fqï¼Œ32*2ï¼Œgcc11                 | 25-27  | 34-35      | 63                   |                                                              |
| pugz8 gzï¼Œ64*1ï¼Œ                | 30     | 60         |                      | gunzip and push data to memory cost 30<br/>gunzip and push data to memory cost 33 |
|                                 | 30     | 78         |                      | gunzip and push data to memory cost 29.7678<br/>gunzip and push data to memory cost 33 |
|                                 | 28     | 78         |                      | gunzip and push data to memory cost 31<br/>gunzip and push data to memory cost 33 |
| ğŸ‘†optimize size_approxï¼ˆæ™šä¸Šï¼‰   | 41     | 27         |                      | gunzip and push data to memory cost 31.9899<br/>gunzip and push data to memory cost 34.7715 |
|                                 | 38     | 29         |                      |                                                              |
| ğŸ‘†32*2                           | 36-38  | 22-24      |                      | gunzip and push data to memory cost 28.8973<br/>gunzip and push data to memory cost 29.4034<br/>gunzip and push data to memory cost 30.8625<br/>gunzip and push data to memory cost 31.558 |
|                                 | 36-37  | 23-24      |                      | gunzip and push data to memory cost 28.9341<br/>gunzip and push data to memory cost 29.0582<br/>gunzip and push data to memory cost 31.0212<br/>gunzip and push data to memory cost 31.1593 |
| ğŸ‘†all 32*2ï¼Œpugz 8               | 36-37  | 39-40      | 76/ï½32 threads work | gunzip and push data to memory cost 28.8359<br/>gunzip and push data to memory cost 28.9144<br/>gunzip and push data to memory cost 30.8682<br/>gunzip and push data to memory cost 31.0669 |
|                                 |        |            | 76                   | gunzip and push data to memory cost 28.7751<br/>gunzip and push data to memory cost 28.9429<br/>gunzip and push data to memory cost 30.7982<br/>gunzip and push data to memory cost 31.1148 |
|                                 |        |            |                      |                                                              |
| ğŸ‘†all 32*2ï¼Œpugz 2               | 34-35  | 37-38      | 73ï¼ˆsize waï¼ï¼ï¼ï¼‰  | gunzip and push data to memory cost 46<br/>gunzip and push data to memory cost 47<br/>gunzip and push data to memory cost 50<br/>gunzip and push data to memory cost 52 |
|                                 |        |            | 73                   | gunzip and push data to memory cost 47<br/>gunzip and push data to memory cost 48<br/>gunzip and push data to memory cost 51<br/>gunzip and push data to memory cost 52 |
|                                 |        |            | 73                   | gunzip and push data to memory cost 46<br/>gunzip and push data to memory cost 47<br/>gunzip and push data to memory cost 51<br/>gunzip and push data to memory cost 52 |
| ğŸ‘†32*2ï¼Œpugz 2ï¼Œdisk inï¼Œshm out | 36-36  |            | 75                   | gunzip and push data to memory cost 47<br/>gunzip and push data to memory cost 47<br/>gunzip and push data to memory cost 51<br/>gunzip and push data to memory cost 52 |
|                                 |        |            | 74                   |                                                              |

å¥½å•Šï¼Œç°åœ¨å‘ç°pugzçš„è¾“å…¥æœ‰ç‚¹å­é—®é¢˜ï¼Œæ˜æ˜pugzå¾ˆå¿«ï¼Œ8threadåªè¦20å¤šså°±å®Œæˆäº†ï¼Œå…¨éƒ¨æ”¾åœ¨äº†æ— é™å¤§çš„é˜Ÿåˆ—Q0é‡Œé¢ï¼Œä½†æ˜¯produceréƒ¨åˆ†ä»Q0é‡Œé¢getæ•°æ®çš„æ—¶å€™å°±æœ‰ç‚¹æ…¢äº†ï¼Œéœ€è¦ä¸æ–­çš„getï¼Œmemcpyï¼Œdeleteï¼Œ

![image-20211010210610712](/Users/ylf9811/Library/Application Support/typora-user-images/image-20211010210610712.png)

è¿™ä¸ªæ˜¯fatèŠ‚ç‚¹ä¸Šæçš„æµ‹è¯•ï¼Œå¯ä»¥çœ‹åˆ°ç”Ÿäº§è€…çš„è¿™ä¸ªå‡½æ•°æ…¢çš„ä¸€æ‰¹ï¼Œå…·ä½“çš„æ˜¯ï¼Œé‡Œé¢çš„memcpyå’Œæ— é”é˜Ÿåˆ—çš„å·´æ‹‰å·´æ‹‰ï¼Œç°åœ¨å‡†å¤‡çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼Œå…ˆæŠŠæ¯”è¾ƒè€—æ—¶çš„size_approxæ‹¿åˆ°tryåé¢ï¼ŒæŠŠä¸¤ä¸ªsize_approxåˆå¹¶ã€‚

updateğŸ‘†ã€‚

å‘ç°ä¼˜åŒ–è¿‡size_approxä¹‹åï¼Œ8ä¸ªçº¿ç¨‹pugzå°±åŸºæœ¬ä¸Šåˆèƒ½ä¾›åº”èµ·æŸ¥è¯¢æ“ä½œäº†ã€‚

è¯•äº†ä¸¤ä¸ªçº¿ç¨‹pugzï¼Œæ•ˆæœå’Œ8å·®ä¸å¤šï¼Œä½†æ˜¯æœ‰æ—¶å€™ä¼šè¾“å‡ºæ–‡ä»¶çš„sizeä¸å¤ªå¯¹ï¼Ÿ

## 1011

æ˜¨æ™šçš„é”™è¯¯å¤ç°ä¸å‡ºæ¥äº†ã€‚æ·¦

//TODOğŸ‘†wa



|                                                              | getMap | writeDone | totalCost | pugzCost                                                     |
| ------------------------------------------------------------ | ------ | --------- | --------- | ------------------------------------------------------------ |
| rm -rf /dev/shm/*combine_read* && sleep 2 && mpirun -n 2 ../ST_BarcodeMap-0.0.1 --in DP8400016231TR_D1.barcodeToPos.h5 --in1 V300091300_L03_read_1.fq.gz  --in2 V300091300_L04_read_1.fq.gz --out /dev/shm/combine_read.fq --mismatch 2 --thread 32 --usePugz --pugzThread 2 | 30-31  | 36-39     | 71        | gunzip and push data to memory cost 58<br/>gunzip and push data to memory cost 59<br/>gunzip and push data to memory cost 62<br/>gunzip and push data to memory cost 63 |
| rm -rf /dev/shm/*combine_read* && sleep 2 && mpirun -n 2 ../ST_BarcodeMap-0.0.1 --in DP8400016231TR_D1.barcodeToPos.h5 --in1 V300091300_L03_read_1.fq.gz  --in2 V300091300_L04_read_1.fq.gz --out /dev/shm/combine_read.fq --mismatch 2 --thread 30 --usePugz --pugzThread 2 | 30-32  | 37-39     | 72        | gunzip and push data to memory cost 55<br/>gunzip and push data to memory cost 58<br/>gunzip and push data to memory cost 61<br/>gunzip and push data to memory cost 62 |
|                                                              |        |           | 71        |                                                              |
| rm -rf /dev/shm/*combine_read* && sleep 2 && mpirun -n 2 ../ST_BarcodeMap-0.0.1 --in DP8400016231TR_D1.barcodeToPos.h5 --in1 V300091300_L03_read_1.fq.gz  --in2 V300091300_L04_read_1.fq.gz --out /dev/shm/combine_read.fq --mismatch 2 --thread 28 --usePugz --pugzThread 2 |        |           | 72        |                                                              |
| rm -rf /dev/shm/*combine_read* && sleep 2 && mpirun -n 2 ../ST_BarcodeMap-0.0.1 --in DP8400016231TR_D1.barcodeToPos.h5 --in1 V300091300_L03_read_1.fq.gz  --in2 V300091300_L04_read_1.fq.gz --out /dev/shm/combine_read.fq --mismatch 2 --thread 26 --usePugz --pugzThread 2 |        |           | 75        |                                                              |
| rm -rf /dev/shm/*combine_read* && sleep 2 && mpirun -n 2 ../ST_BarcodeMap-0.0.1 --in DP8400016231TR_D1.barcodeToPos.h5 --in1 V300091300_L03_read_1.fq.gz  --in2 V300091300_L04_read_1.fq.gz --out /dev/shm/combine_read.fq --mismatch 2 --thread 24 --usePugz --pugzThread 2 |        |           | 77        |                                                              |
|                                                              |        |           | 76        |                                                              |
|                                                              |        |           |           |                                                              |
|                                                              |        |           |           |                                                              |

ç»è¿‡æµ‹è¯•ï¼Œpugzï¼Œå‘ç°åŒnumaèŠ‚ç‚¹çš„è¯ï¼Œæ¯ä¸ªèŠ‚ç‚¹28ä¸ªæŸ¥è¯¢çº¿ç¨‹å°±è¶³å¤Ÿäº†ï¼Œè¿™æ ·å°±è…¾å‡ºæ¥4ä¸ªçº¿ç¨‹ç»™pigzï¼Œ

```c++
				while (Q->try_dequeue(now) == 0) {
            if (Q->size_approx() == 0 && *wDone == 1) {
                ret = 0;
                break;
            }
            usleep(100);
        }
        if (Q->size_approx() == 0 && *wDone == 1) {
            ret = 0;
            break;
        }
```

ç…ç…ç…ç…ï¼Œè¿™äº›çš„å•¥ç©æ„ï¼ŒåŸæ¥è¾“å‡ºæ–‡ä»¶çš„å¤§å°è€æ˜¯å°ä¸€ä¸¢ä¸¢ï¼Œå¯èƒ½whileçš„æ—¶å€™ä¸€ç›´==0ï¼Œçªç„¶æ¥äº†ä¸€ä¸ªï¼ˆä¹Ÿæ˜¯æœ€åä¸€ä¸ªï¼ŒwDoneç½®æˆ1ï¼Œæ¥ç€-_-ï¼‰ï¼Œæ¥ç€dequeueå‡ºæ¥äº†ï¼Œç„¶åæ¥ç€ifé‡Œé¢size==0ï¼ŒwDone==1ï¼Œå°±GGäº†ï¼Œæœ€åä¸€å—æ•°æ®å°±ç›´æ¥ä¸è¦äº†ã€‚

## 1012

ç»è¿‡ç®€å•çš„æµ‹è¯•ï¼ŒæŸ¥è¯¢èµ·ç è¦40sï¼Œæ„å»ºhashmapå’Œbfè¦30sï¼Œpugzå¯ä»¥ä¸¤ä¸ªçº¿ç¨‹ï¼ˆ40+sï¼‰è¢«æ„å»ºæ©ç›–ï¼ŒåŸºæœ¬ä¸Šä¸å½±å“ï¼ˆ68-70ï¼‰ï¼Œä½†æ˜¯pigzè¦10ä¸ªçº¿ç¨‹å·¦å³æ‰èƒ½è¾¾åˆ°40sï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ä¼šå½±å“æŸ¥è¯¢ï¼Œä½†æ˜¯æŸ¥è¯¢éœ€è¦>28ä¸ªçº¿ç¨‹æ‰èƒ½è¾¾åˆ°40så·¦å³ï¼Œä¹Ÿå°±æ˜¯è¯´å•èŠ‚ç‚¹å‹ç¼©çš„è¯ï¼Œåªèƒ½ç©ºå‡ºæ¥4ä¸ªçº¿ç¨‹ç»™pigzåšå‹ç¼©ï¼Œæ˜¾ç„¶æ˜¯ä¸å¤ªå¤Ÿçš„ï¼ŒåŒèŠ‚ç‚¹çš„è¯ï¼Œ27+5çš„ç»“æ„ä¼¼ä¹æ¯”è¾ƒåˆç†ï¼Œå…ˆç®€å•æµ‹è¯•ä¸€ä¸‹ï¼Œä¸åˆå¹¶ï¼š

|                                                   | query | pigz    |      |
| ------------------------------------------------- | ----- | ------- | ---- |
| å•çº¯æŸ¥è¯¢æ—¶é—´32*2                                  | 36/38 |         |      |
| å•çº¯æŸ¥è¯¢æ—¶é—´30*2                                  | 37/38 |         |      |
| å•çº¯æŸ¥è¯¢æ—¶é—´28*2                                  | 39/40 |         |      |
| å•çº¯æŸ¥è¯¢æ—¶é—´26*2                                  | 41/42 |         |      |
|                                                   |       |         |      |
| --thread 28 --usePigz --pigzThread 2 --outGzSpilt | 40/40 | 102/121 |      |
| --thread 28 --usePigz --pigzThread 4 --outGzSpilt | 43/44 | 61/61   |      |
| --thread 28 --usePigz --pigzThread 6 --outGzSpilt | 42/44 | 44/44   |      |
|                                                   |       |         |      |
|                                                   |       |         |      |

å¥½å•Šï¼Œä¸åˆå¹¶è¾“å‡ºæ•ˆæœè¿˜æ˜¯å¾ˆå¥½çš„ï¼Œç»“æœä¹Ÿæ˜¯å¯¹çš„ã€‚

ä¸‹é¢å†™å†™åˆå¹¶è¾“å‡ºï¼Œemmmmï¼Œå’Œå¤§å¸ˆå…„è®¨è®ºäº†ä¸€ä¸‹ï¼Œè§‰å¾—ä¸¤ä¸ªmpiè¿›ç¨‹å†™åŒä¸€ä¸ªé—®ä»·å¯èƒ½ä¼šå¾ˆæ…¢ï¼Œå¯ä»¥å†å¼€ä¸€ä¸ªmpiè¿›ç¨‹ï¼Œå®ƒå…ˆå¯åŠ¨ä¸€ä¸ªæ¥æ”¶çº¿ç¨‹æ”¶é›†p0p1å‘æ¥çš„fqæ•°æ®ï¼Œç„¶ååœ¨ä¸¤ä¸ªnumaèŠ‚ç‚¹ä¸Šåˆ†åˆ«å¯åŠ¨6ä¸ªçº¿ç¨‹åšpigzã€‚





## 1013

